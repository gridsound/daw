<!DOCTYPE html>
<html>
<head>
<title>GridSound</title>
<meta charset='UTF-8'/>
<meta name='viewport' content='width=device-width, user-scalable=no'/>
<meta name='description' content='A free and Open-Source DAW (digital audio workstation)'/>
<meta name='google' content='notranslate'/>
<meta property='og:type' content='website'/>
<meta property='og:title' content='GridSound (an open-source digital audio workstation)'/>
<meta property='og:url' content='https://gridsound.github.io/'/>
<meta property='og:image' content='https://gridsound.github.io/assets/og-image.jpg'/>
<meta property='og:image:width' content='800'/>
<meta property='og:image:height' content='400'/>
<meta name='theme-color' content='#3a5158'/>
<link rel='manifest' href='manifest.json'/>
<link rel='shortcut icon' href='assets/favicon.png'/>
<style>
.gsuiAudioBlock{--bd-width: 0px;--bd-radius: 4px;--bg: rgba( 0, 0, 0, .6 );--bg-head: rgba( 0, 0, 0, .3 );color:#cce;position:absolute;display:flex;flex-direction:column;box-sizing:border-box;overflow:hidden;top:0;height:100%;border-style:solid;border-width:var(--bd-width) 0;border-radius:var(--bd-radius);cursor:default;user-select:none;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;transition:.1s;transition-property:color}.gsuiAudioBlock.gsui-selected{color:#f99}.gsuiAudioBlock .gsui-bg{position:absolute;width:100%;height:100%;background-color:currentColor;filter:brightness(.15);opacity:.8}.gsuiAudioBlock .gsui-head{position:relative;overflow:hidden;z-index:1;padding:.3em .5em;font-size:12px;font-weight:700;white-space:nowrap;text-overflow:ellipsis;text-shadow:0 0 3px rgba(0,0,0,.7);background-color:var(--bg-head)}.gsuiAudioBlock .gsui-name:empty:before{content:"Untitled";font-style:italic;opacity:.5}.gsuiAudioBlock .gsui-content{flex:1;position:relative}.gsuiAudioBlock .gsui-crop{position:absolute;z-index:2;top:0;width:50%;max-width:8px;height:100%;background-color:currentColor;opacity:0;transition:opacity .2s}.gsuiAudioBlock .gsui-crop.gsui-hover,.gsuiAudioBlock .gsui-crop:hover{opacity:.2}.gsuiAudioBlock .gsui-crop.gsui-b{right:0}.gsui-nocrop .gsui-crop{display:none!important}.gsuiAudioBlock[data-type=key] .gsui-bg{filter:brightness(.7);opacity:.6}.gsuiAudioBlock[data-type=key] .gsui-head{background-color:transparent}.gsuiAudioBlock svg{position:absolute;top:0;width:100%;height:100%;fill:currentColor;opacity:.3}.gsuiAudioBlock rect{rx:2px}.gs-row-tiny .gsuiAudioBlock .gsui-head{display:flex;align-items:center;padding-top:0;padding-bottom:0;height:100%;background-color:transparent}.gs-row-tiny .gsuiAudioBlock .gsui-bg{filter:brightness(.7);opacity:.6}.gs-row-tiny .gsuiAudioBlock .gsui-content{position:absolute;top:0;width:100%;height:100%}.gsuiBeatLines{fill:#000;color:#ff5}.gsuiBeatLines rect{fill:inherit}.gsuiBeatLines .gsui-step{opacity:.2}.gsuiBeatLines .gsui-beat{opacity:.5}.gsuiBeatLines .gsui-measure{opacity:.6}.gsuiBeatLines .gsui-currentTime{fill:currentColor;stroke:currentColor;stroke-opacity:.1;stroke-width:5px}.gsuiBeatLines .gsui-hlEnd,.gsuiBeatLines .gsui-hlStart{opacity:.25}.gsuiGridSamples{--timeline-height: 32px;--panel-min-width: 24px;--panel-max-width: 320px;--grid-bg: #3a5158;--panel-bg: #3a3a3a;--border-color: #111;position:relative;width:100%;height:100%;cursor:default;user-select:none;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none}.gsuiGridSamples .gsuigs-grid,.gsuiGridSamples .gsuigs-panel{position:absolute;overflow:hidden;top:var(--timeline-height);bottom:0}.gsuiGridSamples .gsuigs-grid{right:0;border-top:1px solid var(--border-color)}.gsuiGridSamples .gsuigs-panel{box-sizing:border-box;min-width:var(--panel-min-width);max-width:var(--panel-max-width);border:0 solid var(--border-color);border-width:1px 1px 0 0;background-color:var(--panel-bg)}.gsuiGridSamples .gsuigs-extend{position:absolute;z-index:1;top:0;right:0;width:6px;height:100%;transition:background-color .2s}.gsuiGridSamples .gsuigs-extend.gsui-hover,.gsuiGridSamples .gsuigs-extend:hover{background-color:rgba(128,128,128,.5)}.gsuiGridSamples .gsuiTimeLine{position:absolute;z-index:1;height:var(--timeline-height);top:0;right:0;border-left:1px solid var(--border-color)}.gsuiGridSamples .gsuiBeatLines{position:absolute;width:100%;height:100%;background-color:var(--grid-bg)}.gsuiGridSamples .gsuigs-content,.gsuiKeys{position:relative}.gsuiGridSamples .gsuigs-grid .gsuigs-content{position:absolute;right:0}.gsuiGridSamples .gsuigs-select{position:absolute;box-sizing:border-box;margin:-1px 0 0 -1px;border:2px solid #f55;border-radius:4px;background-color:rgba(216,26,26,.3);transition:.2s;transition-property:opacity,visibility}.gsuiGridSamples .gsuigs-select.hidden{opacity:0;visibility:hidden}.gsuiKeys{user-select:none;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none}.gsuiKey,.gsuiKey-row{position:relative;box-sizing:border-box;height:1em}.gsuiKey-row[data-key$="#"]{background-color:rgba(0,0,0,.1)}.gsuiKey-row[data-key$=c],.gsuiKey-row[data-key$=f]{border-bottom:1px solid rgba(0,0,0,.2)}.gsuiKey-row>div,.gsuiTrack-row>div{position:absolute;top:0;bottom:0;width:100%}.gsuiKey{height:1.5em;background-image:linear-gradient(90deg,#888,#eee);cursor:default}.gsuiKey[data-key$="#"]{position:absolute;z-index:1;width:65%;height:1em;margin-top:-.5em;border-radius:0 .1em .1em 0;background-image:linear-gradient(90deg,#111,#444)}.gsuiKey[data-key=c]{background-image:linear-gradient(90deg,#888,#ccc)}.gsuiKey[data-key=c]:after{counter-increment:octave -1;content:"C" counter(octave);position:absolute;right:.25em;bottom:0;color:#000;font-size:calc(6px + .25em);font-family:monospace}.gsuiKey.gsui-active{background-image:linear-gradient(90deg,#353b52,#7886bd)}.gsuiKey[data-key=c],.gsuiKey[data-key=f]{border-bottom:1px solid rgba(0,0,0,.2)}.gsuiKey:last-child{border-bottom:0}.gsuiKey[data-key=a],.gsuiKey[data-key=d],.gsuiKey[data-key=g]{height:2em}:root{--gsuiPanels-bdSize: 1px;--gsuiPanels-bdColor: #222;--gsuiPanels-extendSize: 5px;--gsuiPanels-extendColor: #888}.gsuiPanels{display:flex;height:100%}.gsuiPanels.gsui-noselect{cursor:default;user-select:none;-ms-user-select:none;-moz-user-select:none;-webkit-user-select:none}.gsuiPanels.gsui-axeY{flex-direction:column}.gsuiPanels>.gsui-panel{box-sizing:border-box;position:relative;border:0 solid var(--gsuiPanels-bdColor)}.gsuiPanels.gsui-axeX>.gsui-panel{min-height:100%;max-height:100%;border-right-width:var(--gsuiPanels-bdSize)}.gsuiPanels.gsui-axeY>.gsui-panel{min-width:100%;max-width:100%;border-bottom-width:var(--gsuiPanels-bdSize)}.gsuiPanels>.gsui-panel:last-child{border:0}.gsuiPanels>.gsui-panel>.gsui-extend{position:absolute;z-index:2147483647;transition:background .2s}.gsuiPanels.gsui-axeX>.gsui-panel>.gsui-extend{height:100%;width:var(--gsuiPanels-extendSize);right:calc((var(--gsuiPanels-extendSize) - var(--gsuiPanels-bdSize))/-2 - var(--gsuiPanels-bdSize))}.gsuiPanels.gsui-axeY>.gsui-panel>.gsui-extend{width:100%;height:var(--gsuiPanels-extendSize);bottom:calc((var(--gsuiPanels-extendSize) - var(--gsuiPanels-bdSize))/-2 - var(--gsuiPanels-bdSize))}.gsuiPanels>.gsui-panel:last-child>.gsui-extend{display:none}.gsuiPanels>.gsui-panel>.gsui-extend.gsui-hover,.gsuiPanels>.gsui-panel>.gsui-extend:hover{background-color:var(--gsuiPanels-extendColor)}.gsuiSpanEditable{--placeholder-opacity: .3;display:flex;align-items:center;overflow:hidden;transition-duration:.2s}.gsuiSpanEditable span{display:inline-block;width:100%;color:inherit;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;min-width:1em;opacity:1;transition:opacity;transition-duration:inherit}.gsuiSpanEditable input{display:none;box-sizing:border-box;width:100%;outline:0;border:0;font-size:1em;color:inherit;background:0 0}.gsuiSpanEditable.gsui-empty span{font-style:italic;opacity:var(--placeholder-opacity)}.gsuiSpanEditable.gsui-editing span{display:none}.gsuiSpanEditable.gsui-editing input{display:block}.gsuiTimeLine{--cursor-color: #fdfd70;--cursor-dur: .1s;--loop-color: #656586;--loop-brd-color: #fff;position:relative;overflow:hidden;font:14px monospace;color:#fff;background:#222;cursor:default;user-select:none;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none}.gsuiTimeLine .gsui-loopLine{position:absolute;z-index:1;width:100%;height:100%}.gsuiTimeLine .gsui-loop{position:absolute;z-index:1;top:0;height:22%}.gsuiTimeLine .gsui-loopBg{position:absolute;width:100%;height:100%;background:var(--loop-color);transition:filter .2s}.gsuiTimeLine .gsui-loopBg.gsui-hover,.gsuiTimeLine .gsui-loopBg:hover{filter:brightness(1.2)}.gsuiTimeLine .gsui-loopExt{position:absolute;z-index:2;width:25%;min-width:5px;max-width:10px;height:250%}.gsuiTimeLine .gsui-loopA{left:-5px}.gsuiTimeLine .gsui-loopB{right:-5px}.gsuiTimeLine .gsui-loopBrd{position:absolute;z-index:0;width:2px;height:100%;background:var(--loop-color);transition:.2s;transition-property:height,background,z-index}.gsuiTimeLine .gsui-loopBrdA{left:-1px}.gsuiTimeLine .gsui-loopBrdB{right:-1px}.gsuiTimeLine .gsui-loopA:hover~.gsui-loopBrdA,.gsuiTimeLine .gsui-loopB:hover~.gsui-loopBrdB,.gsuiTimeLine .gsui-loopBrd.gsui-hover{z-index:1;height:150%;background:var(--loop-brd-color)}.gsuiTimeLine .gsui-currentTime{position:absolute;z-index:1;bottom:0;width:100%;height:50%}.gsuiTimeLine .gsui-cursorLine{position:absolute;bottom:0;width:100%;height:1px;color:var(--cursor-color);opacity:0;transition:.2s;transition-property:opacity,background}.gsuiTimeLine .gsui-currentTime:hover .gsui-cursorLine{opacity:.8}.gsuiTimeLine .gsui-cursor{position:absolute;margin-left:-10px;bottom:1px;transition:left}.gsuiTimeLine .gsui-trans{transition-duration:var(--cursor-dur)}.gsuiTimeLine .gsui-cursor polygon{fill:var(--cursor-color);stroke:var(--cursor-color);stroke-width:4;stroke-linejoin:round}.gsuiTimeLine .gsui-beat,.gsuiTimeLine .gsui-measure,.gsuiTimeLine .gsui-step{position:absolute;display:flex;top:0;bottom:0;width:4em;margin-left:-2em;align-items:center;justify-content:center}.gsuiTimeLine .gsui-measure{font-weight:700}.gsuiTimeLine .gsui-step{opacity:.2}.gsuiTimeLine .gsui-beat,.gsuiTimeLine.gsui-measure .gsui-measure{opacity:.5}.gsuiTimeLine.gsui-beat .gsui-step,.gsuiTimeLine.gsui-measure .gsui-beat,.gsuiTimeLine.gsui-measure .gsui-step{opacity:0}.gsuiToggle{--radius: 8px;--border: 1px solid rgba( 255, 255, 255, .25 );--color: #222;--color-on: #87bd42;--boxshadow: 0 2px 1px rgba( 0, 0, 0, .3 );--boxshadow-on: 0 0 10px #87bd42;--dur: .2s;position:relative;font-size:var(--radius);cursor:pointer}.gsuiToggle .gsui-circle{position:absolute;box-sizing:border-box;width:1em;height:1em;top:50%;left:50%;margin:-.5em 0 0 -.5em;border-radius:50%;border:var(--border);box-shadow:var(--boxshadow);background:var(--color);transition:var(--dur);transition-property:background,box-shadow}.gsuiToggle .gsui-on{box-shadow:var(--boxshadow-on);background:var(--color-on)}.gsuiTrack,.gsuiTrack-row{--head-bg: #444;--head-bg-mute: #393939;--body-bg-mute: rgba( 0, 0, 0, .25 );--text-color: #eee;--border-top-color: rgba( 255, 255, 255, .07 );--border-bottom-color: rgba( 0, 0, 0, .4 );box-sizing:border-box;display:flex;height:1em;border:0 solid;border-width:1px 0;border-top-color:var(--border-top-color);border-bottom-color:var(--border-bottom-color);background-color:var(--head-bg);transition:background-color .2s}.gsuiTrack-row{position:relative;display:block;background-color:transparent}.gsuiTrack .gsuiToggle{--radius: 6px;min-width:24px}.gsuiTrack .gsuiSpanEditable{flex:1;padding-right:10px;font-size:14px;color:var(--text-color)}.gsuiTrack.gsui-mute{background-color:var(--head-bg-mute)}.gsuiTrack-row.gsui-mute{background-color:var(--body-bg-mute)}.gsuiTrack.gsui-mute .gsuiSpanEditable{opacity:.5}.gsuiTrackList{height:100%;background:#333}@font-face{font-family:"Inconsolata";src:url(assets/inconsolata-regular.ttf)}@font-face{font-family:"FontAwesome";src:url(assets/fontawesome.woff?v=4.5.0) format("woff")}@font-face{font-family:"title";src:url(assets/oswald-regular.ttf)}body,html{height:100%;margin:0;font-family:sans-serif;background:#000}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background-color:#555}::-webkit-scrollbar-thumb{background-color:#888}#app{--gsuiPanels-bdSize: 2px;--gsuiPanels-extendSize: 4px;--small-bd-radius: 2px;--ctrl-height: 44px;--ctrl-padding: 4px;--col1-high: #bbf;--col1-middle: #67a;--col2-middle: #d44;--monospace: "Inconsolata", "consolas", monospace;width:100%;height:100%;overflow:hidden;user-select:none;-ms-user-select:none;-moz-user-select:none;-webkit-user-select:none}.absoluteMenu{position:absolute;z-index:2;color:#ddd;border:2px solid #111;border-radius:4px;background-color:#333;transition:.2s;transition-property:opacity,visibility}.absoluteMenu.hidden{opacity:0;visibility:hidden}.absoluteMenu a{display:block;white-space:nowrap;font-size:13px;line-height:2em;padding:0 .5em;cursor:default}.absoluteMenu a:hover{color:#fff;background:#222}#panelsLeftWrap{min-width:200px;max-width:400px;width:300px}#panelsLeft .gsui-panel{min-height:30px;height:0}#panelsLeft .gsui-panel:first-child{min-height:83px;height:200px}#panelsLeft .gsui-panel:last-child{height:calc(100% - 150px)}.panel-content{display:flex;flex-direction:column;box-sizing:border-box;height:100%}.panel-menu,.panel-title{box-sizing:border-box;padding:4px 10px;font-size:13px;border-bottom:1px solid #111}.panel-title{font-weight:700;color:#222;background-color:#666}.panel-menu{color:#222;background-color:#505050}.panel-btn{display:inline-block;width:16px;padding:4px;font-size:14px;font-family:"FontAwesome";color:#ddd;text-align:center;border-radius:2px;transition:background .2s}.panel-btn+.panel-btn{margin-left:.5em}.panel-btn:hover{background-color:rgba(0,0,0,.2)}.panel-body{flex:1;overflow:auto;background-color:#555}#panelCmps{position:relative;background-color:#444}#panelCmps .panel-title{display:flex;align-items:center;height:var(--ctrl-height);padding-top:0;padding-bottom:0;font-weight:400;background:0 0}#title:before{content:"GridSound";font-family:"title";font-size:28px;color:#fff}#cmpMenu{left:100%;margin-left:5px}.cmp{box-sizing:border-box;display:flex;color:#bbb;font-size:12px;cursor:pointer;background-color:var(--col1-middle);filter:brightness(.9)}.cmp .save{display:flex;overflow:hidden;align-items:center;justify-content:center;width:0;background-color:var(--col2-middle)}.cmp.notSaved .save{min-width:30px}.cmp .save:before{content:"\f0a0";font:20px "FontAwesome";color:#ddd}.cmp .info{flex:1;padding:4px;overflow:hidden;transition:padding-left .2s}.cmp .info:hover{padding-left:8px}.cmp .menu{display:flex;align-items:center;justify-content:center;min-width:20px}.cmp .menu:before{content:"\f142";font:18px "FontAwesome"}.cmp .menu:hover{color:#fff}.cmp.loaded{filter:none}.cmp+.cmp{border-top:1px solid rgba(0,0,0,.2)}.cmp .name{overflow:hidden;color:#ddd;font-size:13px;font-weight:700;white-space:nowrap;text-overflow:ellipsis}.cmp.notSaved .name:before{content:"*"}.cmp .name:empty:after{font-style:italic;content:"Untitled"}.cmp .bpm{margin-right:1em}.cmp .bpm:before,.cmp .duration:before{font-family:"FontAwesome";margin-right:.4em}.cmp .bpm:before{content:"\f001"}.cmp .duration:before{content:"\f017"}.action{display:flex;box-sizing:border-box;align-items:center;cursor:default;height:28px;padding-right:.4em;color:#bbb;font-size:13px;font-family:var(--monospace);background-color:#333;transition:background-color .2s}.action+.action{border-top:1px solid #222}.action:hover{background-color:#444}.action:before{content:"";display:block;width:4px;height:100%;background-color:var(--col1-middle);transition:inherit}.action.undone:before{background-color:#000}.actionText{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition-property:opacity;transition-duration:inherit}.action.undone .actionText{opacity:.5}.actionIcon{width:16px;margin:0 .4em;font:14px "FontAwesome";text-align:center}.actionIcon:after{position:absolute;left:10px;top:-3px;font-size:8px}.actionIcon.plus:after{content:"\f067"}.actionIcon.minus:after{content:"\f068"}.actionIcon.clock:before{content:"\f017"}.actionIcon.name:before{content:"\f040"}.actionIcon.mute:before{content:"\f026"}.actionIcon.unmute:before{content:"\f028"}.actionIcon.toggle-off:before{content:"\f204"}.actionIcon.toggle-on:before{content:"\f205"}.actionIcon.paint:before{content:"\f1fc"}#patNew:before,.actionIcon.add:before{content:"\f067"}#patRemove:before,.actionIcon.remove:before{content:"\f1f8"}.actionIcon.erase:before{content:"\f12d"}.actionIcon.selection:before{content:"\f245"}#patterns,.actionIcon{position:relative}#patterns .gsuiAudioBlock{position:relative;width:100%;height:64px;color:#bbb;--bd-radius: 0}#patterns .gsuiAudioBlock.selected{color:var(--col1-high)}#patterns .gsuiAudioBlock.selected .gsui-head:before{content:"\f115";font-family:"FontAwesome";font-weight:400}#panelsMain>.gsui-panel:last-child{width:calc(100% - 300px)}#panelsMain>.gsui-panel:last-child>.gsuiPanels>.gsui-panel:first-child{min-height:400px;height:0}#panelsMain>.gsui-panel:last-child>.gsuiPanels>.gsui-panel:last-child{height:calc(100% - 400px)}#controlsWrap{display:flex;align-items:center;box-sizing:border-box;height:var(--ctrl-height);padding:var(--ctrl-padding);border-bottom:1px solid #000;background-color:#444}#controlsWrap .ctrl-item{box-sizing:border-box;color:#ddd;height:100%;border-radius:var(--small-bd-radius)}#controlsWrap .ctrl-item+.ctrl-item{margin-left:6px}#controlsWrap .btn.big{display:flex;align-items:center;justify-content:center;font-size:14px;font-family:"FontAwesome";border:1px solid rgba(0,0,0,.8);width:calc(var(--ctrl-height) - 2*var(--ctrl-padding))}#controlsWrap .btn.big:active{padding-top:4px;box-shadow:inset 0 3px 0 rgba(0,0,0,.25)}#play{background-color:var(--col1-middle)}#stop{background-color:#888}#play:before{content:"\f04b"}#play.pause:before{content:"\f04c"}#stop:before{content:"\f04d"}#bpm,#clock{display:flex;font-size:30px;font-family:var(--monospace);padding:0 .3em;border:3px solid rgba(0,0,0,.3);background-color:#222}#bpm{align-items:center}#bpmText:before{content:"bpm";font-size:calc(9px + .1em);margin-left:.5em;opacity:.5}#clock{align-items:baseline;line-height:1em}#clockSec:before{content:":"}#clockMs:before{content:"."}#clockMs{font-size:.5em}#settings{width:auto!important;padding-left:.4em;padding-right:.4em;font-family:"FontAwesome";background-color:var(--col2-middle)}#settings:before{content:"\f001";margin-right:.4em}#settings:after{content:"\f013"}#keysGridWrap,#mainGridWrap{flex:1}#mainGridWrap .gsuiTrack-row>div{top:-1px}.gsuiGridSamples{background-color:#2f2f2f}#patternMenu{position:relative;display:flex;align-items:center;padding:4px 6px;font-size:12px;color:#ddd;border-bottom:1px solid #111;background-color:#444}#patternMenu:before{content:"Pattern :";font-style:italic;font-weight:700;font-size:11px;text-shadow:1px 1px 0 #000;opacity:.35}#patternName{margin-left:.75em;padding:4px 8px;border-radius:4px;font-family:var(--monospace);cursor:default;background-color:var(--col1-middle);transition:filter .2s}#patternName:empty:before{content:"Untitled";font-style:italic}#patternName:hover{color:#fff;filter:brightness(1.1)}#settingsPopupWrap{position:absolute;z-index:5;display:flex;align-items:center;justify-content:center;top:0;left:0;width:100%;height:100%;color:#ddd;background-color:rgba(0,0,0,.6);transition:.5s;transition-property:opacity,visibility}#settingsPopupWrap.hidden{opacity:0;visibility:hidden}#settingsPopup{width:600px;overflow:hidden;border-radius:4px;background-color:#555;box-shadow:0 0 50px #000}#settingsPopup form,#settingsPopup header{padding:10px}#settingsPopup header{background:#333}#settingsPopup fieldset{border:2px solid #444;border-radius:4px;margin-bottom:10px}#settingsPopup legend{font-size:11px;font-weight:700;opacity:.5}#settingsPopup .param{display:flex;align-items:center}#settingsPopup .param+.param{margin-top:5px}#settingsPopup .param-title{flex:1}#settingsPopup .param-values{flex:1;font-family:var(--monospace)}#settingsPopup [type=radio]:checked+label{font-weight:700}#settingsPopup input{border-radius:2px;border:0;color:inherit}#settingsPopup input[type=number],#settingsPopup input[type=text]{width:150px;padding:.2em .5em;font-family:inherit;background:rgba(255,255,255,.1)}#settingsPopup .submit-wrap{text-align:center}#settingsPopup input[type=submit]{padding:.5em 1em;font-size:14px;font-weight:700;color:#fff;background-color:var(--col1-middle)}
</style>
</head>
<body>
<div id='app'></div>
<template id="appContent">
	<div data-panel="1" id="panelCmps" class="panel-content panel-left">
		<div class="panel-title">
			<div id="title"></div>
			<div id="username"></div>
		</div>
		<div id="cmps" class="panel-body"></div>
		<div id="cmpMenu" class="absoluteMenu hidden">
			<a id="exportCompositionJSON">Export to JSON</a>
			<a id="exportCompositionWAV">Export to WAV</a>
			<a id="deleteComposition">Delete</a>
		</div>
	</div>
	<div data-panel="2" id="panelHistory" class="panel-content panel-left">
		<div class="panel-title">History</div>
		<!--<div class="panel-menu">menu</div>-->
		<div id="history" class="panel-body"></div>
	</div>
	<div data-panel="3" id="panelPatterns" class="panel-content panel-left">
		<div class="panel-title">Patterns</div>
		<div class="panel-menu">
			<a id="patNew" class="panel-btn" title="Create a new pattern"></a
			><a id="patRemove" class="panel-btn" title="Delete the selected pattern"></a>
		</div>
		<div id="patterns" class="panel-body gsui-nocrop"></div>
	</div>
	<div data-panel="5" id="panelMain" class="panel-content">
		<div id="controlsWrap">
			<a id="play" class="ctrl-item btn big"></a>
			<a id="stop" class="ctrl-item btn big"></a>
			<div id="clock" class="ctrl-item">
				<div id="clockMin"></div>
				<div id="clockSec"></div>
				<div id="clockMs"></div>
			</div>
			<div id="bpm" class="ctrl-item">
				<span id="bpmNumber"></span>
				<span id="bpmText"></span>
			</div>
			<a id="settings" class="ctrl-item btn big"></a>
		</div>
		<div id="mainGridWrap"></div>
	</div>
	<div data-panel="6" id="panelKeys" class="panel-content">
		<div id="patternMenu">
			<div id="patternName"></div>
		</div>
		<div id="keysGridWrap"></div>
	</div>
	<div id="settingsPopupWrap" class="hidden">
		<div id="settingsPopup">
			<header>Settings</header>
			<form id="settingsPopupForm">
				<fieldset>
					<legend>GridSound's DAW settings</legend>
					<div class="param">
						<div class="param-title">Clock display</div>
						<div class="param-values">
							<input id="radioClSec" name="clock" type="radio"/> <label for="radioClSec">min:sec.ms</label><br/>
							<input id="radioClBeat" name="clock" type="radio"/> <label for="radioClBeat">beats:steps.milisteps</label>
						</div>
					</div>
				</fieldset>
				<fieldset>
					<legend>Composition settings</legend>
					<div class="param">
						<div class="param-title">Title</div>
						<div class="param-values"><input type="text"/></div>
					</div>
					<div class="param">
						<div class="param-title">BPM</div>
						<div class="param-values"><input type="number" min="1" max="999"/></div>
					</div>
					<div class="param">
						<div class="param-title">Beats per measure</div>
						<div class="param-values"><input type="number" min="1" max="16"/></div>
					</div>
					<div class="param">
						<div class="param-title">Steps per beat</div>
						<div class="param-values"><input type="number" min="1" max="16"/></div>
					</div>
				</fieldset>
				<div class="submit-wrap">
					<input type="submit" value="Save"/>
				</div>
			</form>
		</div>
	</div>
</template>
<template id="appCmp">
	<div class="appCmp">
		<span class="name"></span>
		<span class="bpm"></span>
		<span class="duration"></span>
	</div>
</template>
<template id="gsuiGridSamples">
	<div class="gsuiGridSamples" tabindex="1">
		<div class="gsuigs-panel">
			<div class="gsuigs-extend"></div>
			<div class="gsuigs-content"></div>
		</div>
		<div class="gsuigs-grid">
			<div class="gsuigs-content"></div>
			<div class="gsuigs-select hidden"></div>
		</div>
	</div>
</template>
<template id="gsuiTimeLine">
	<div class="gsuiTimeLine">
		<div class="gsui-loopLine"></div>
		<div class="gsui-loop">
			<div class="gsui-loopExt gsui-loopA"></div>
			<div class="gsui-loopExt gsui-loopB"></div>
			<div class="gsui-loopBrd gsui-loopBrdA"></div>
			<div class="gsui-loopBrd gsui-loopBrdB"></div>
			<div class="gsui-loopBg"></div>
		</div>
		<svg class="gsui-cursor" width="20" height="10">
			<polygon points="2,2 10,8 18,2"/>
		</svg>
		<div class="gsui-currentTime">
			<div class="gsui-cursorLine"></div>
		</div>
	</div>
</template>
<template id="gsuiKeys-octave"
	><div class="gsuiKey" data-key="b" ><div data-key="b"  class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="a#"><div data-key="a#" class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="a" ><div data-key="a"  class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="g#"><div data-key="g#" class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="g" ><div data-key="g"  class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="f#"><div data-key="f#" class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="f" ><div data-key="f"  class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="e" ><div data-key="e"  class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="d#"><div data-key="d#" class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="d" ><div data-key="d"  class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="c#"><div data-key="c#" class="gsui-row gsuiKey-row"><div></div></div></div
	><div class="gsuiKey" data-key="c" ><div data-key="c"  class="gsui-row gsuiKey-row"><div></div></div></div
></template>
<template id="gsuiTrackList">
	<div class="gsuiTrackList"></div>
</template>
<template id="gsuiTrack">
	<div class="gsuiTrack">
		<div class="gsui-row gsuiTrack-row"><div></div></div>
	</div>
</template>
<template id="gsuiToggle">
	<div class="gsuiToggle">
		<div class="gsui-circle"></div>
	</div>
</template>
<template id="gsuiSpanEditable">
	<div class="gsuiSpanEditable">
		<span></span>
		<input type="text"/>
	</div>
</template>
<template id="gsuiAudioBlock">
	<div class="gsuiAudioBlock">
		<div class="gsui-bg"></div>
		<div class="gsui-head">
			<span class="gsui-name"></span>
		</div>
		<div class="gsui-content"></div>
		<div class="gsui-crop gsui-a"></div>
		<div class="gsui-crop gsui-b"></div>
	</div>
</template>
<script>
"use strict";function gsuiAudioBlock(){var e=this._clone();e.querySelectorAll("*").forEach(function(e){e.gsuiAudioBlock=this},this),this.rootElement=e,this._elName=e.querySelector(".gsui-name"),this._elCnt=e.querySelector(".gsui-content"),this._elCropA=e.querySelector(".gsui-crop.gsui-a"),this._elCropB=e.querySelector(".gsui-crop.gsui-b"),this._elCropA.onmousedown=this._elCropB.onmousedown=this._evmdCrop.bind(this),e.onmousedown=this._evmdRoot.bind(this),this.selected=!1}function gsuiBeatLines(e){this.rootElement=e=e||document.createElementNS(SVGURL,"svg"),e.setAttribute("preserveAspectRatio","none"),e.classList.add("gsuiBeatLines"),this.elTime=this._newRect(),this._elLoopA=this._newRect(),this._elLoopB=this._newRect(),this.elTime.setAttribute("class","gsui-currentTime"),this._elLoopA.setAttribute("class","gsui-hlStart"),this._elLoopB.setAttribute("class","gsui-hlEnd"),this._elLoopA.setAttribute("x",0),this._elLoopB.setAttribute("width","10000%"),this._offset=0,this._pxPerBeat=32,this._beatsPerMeasure=this._stepsPerBeat=4,this.steps=[],this.currentTime(0),this.loop(!1)}function gsuiGridSamples(){var e=this._clone();this.rootElement=e,this._elPanel=e.querySelector(".gsuigs-panel"),this._elGrid=e.querySelector(".gsuigs-grid"),this._elPanelExt=this._elPanel.querySelector(".gsuigs-extend"),this._elPanelCnt=this._elPanel.querySelector(".gsuigs-content"),this._elGridCnt=this._elGrid.querySelector(".gsuigs-content"),this._elSelection=this._elGrid.querySelector(".gsuigs-select"),this.uiTimeLine=new gsuiTimeLine,this.uiBeatLines=new gsuiBeatLines,e.prepend(this.uiTimeLine.rootElement),this._elGrid.prepend(this.uiBeatLines.rootElement),this.rows=this._elGridCnt.childNodes,this._rowsById={},e.oncontextmenu=function(){return!1},e.onkeydown=this._evkdRoot.bind(this),this._elPanelExt.onmousedown=this._evmdPanelEx.bind(this),this._elGrid.onmousedown=this._evmdGrid.bind(this),this._elGrid.onwheel=this._evowGrid.bind(this),this._elPanel.onwheel=this._evowPanel.bind(this),this.uiTimeLine.onchangeCurrentTime=this._evocCurrentTime.bind(this),this.uiTimeLine.oninputLoop=this._evoiLoop.bind(this),this._panelMaxWidth=1/0,this._panelMinWidth=this._contentY=this._timeOffset=0,this._pxPerBeat=80,this._fontSizeTiny=48,this._uiBlocks={},this._uiBlocksSelected={},this.panelWidth(100)}function gsuiKeys(){var e=document.createElement("div");this._init(),this.rootElement=e,this.rowElements=[],this._nlKeys=e.childNodes,this._nbOct=0,e.className="gsuiKeys",e.onmousedown=this._evmdRoot.bind(this)}function gsuiPanels(){var e=document.createElement("div");this._init(),e.className="gsuiPanels",this.rootElement=e,this.panels=e.childNodes,this._nbPanels=0,this._panelDims=[],this.axe("x")}function gsuiRectMatrix(){var e=document.createElementNS(SVGURL,"svg");this.rootElement=e,e.setAttribute("preserveAspectRatio","none"),e.classList.add("gsuiRectMatrix")}function gsuiSpanEditable(){this.rootElement=this._clone(),this.span=this.rootElement.querySelector("span"),this.input=this.rootElement.querySelector("input"),this.rootElement.ondblclick=this._dblclick.bind(this),this.input.onblur=this._blur.bind(this),this.input.onkeydown=this._keydown.bind(this),this.setPlaceholder(""),this.setValue("")}function gsuiTimeLine(){var e=this._clone(),t=e.querySelector(".gsui-currentTime"),i=e.querySelector(".gsui-loopBg");this.rootElement=e,this._elTime=e.querySelector(".gsui-cursor"),this._elTimeLine=e.querySelector(".gsui-cursorLine"),this._elLoop=e.querySelector(".gsui-loop"),this._elLoopBgCL=i.classList,this._elLoopBrdACL=e.querySelector(".gsui-loopBrdA").classList,this._elLoopBrdBCL=e.querySelector(".gsui-loopBrdB").classList,this._offset=0,this._pxPerBeat=32,this._beatsPerMeasure=this._stepsPerBeat=4,this._steps=[],this.stepRound=1,this.currentTime(0),this.loop(0,0),t.onmousedown=this._mousedownTime.bind(this),t.onmousemove=this._mousemoveTime.bind(this),i.onmousedown=this._mousedownLoop.bind(this,"ab"),e.querySelector(".gsui-loopA").onmousedown=this._mousedownLoop.bind(this,"a"),e.querySelector(".gsui-loopB").onmousedown=this._mousedownLoop.bind(this,"b"),e.querySelector(".gsui-loopLine").onmousedown=this._mousedownLoopLine.bind(this)}function gsuiToggle(){var e=this._clone();e.querySelector("input");this.rootElement=e,this._circCL=e.querySelector(".gsui-circle").classList,this.checked=!1,e.oncontextmenu=function(){return!1},e.onmousedown=this._mousedown.bind(this)}function gsuiTrack(){var e=this._clone();this.rootElement=e,this.rowElement=e.querySelector(".gsui-row"),this.rowElement.remove(),this.uiToggle=new gsuiToggle,this.uiSpan=new gsuiSpanEditable,e.append(this.uiToggle.rootElement),e.append(this.uiSpan.rootElement),this.data={},this.uiToggle.onchange=this._evocToggle.bind(this),this.uiSpan.onchange=this._evocSpan.bind(this),this.toggle(!0)}function gsuiTrackList(){var e=this._clone();this.data={},this.rootElement=e,this._uiTracks={}}gsuiAudioBlock.typeToCmp={buffer:"gsuiWaveform",keys:"gsuiRectMatrix"},gsuiAudioBlock.prototype={setResolution(e,t){this.resW=e,this.resH=t,this._uiContentCmp&&this._uiContentCmp.setResolution(e,t)},name(e){this._elName.textContent=e},select(e){this.rootElement.classList.toggle("gsui-selected",this.selected=!!e)},when(e){this.rootElement.style.left=e+"em"},duration(e){this.rootElement.style.width=e+"em"},datatype(e){e!==this._datatype&&(this._datatype=this.rootElement.dataset.type=e,this._uiContentCmp&&(this._uiContentCmp.remove(),delete this._uiContentCmp))},updateData(e,t,i){var s=this._uiContentCmp;s||(this._uiContentCmp=s=new window[gsuiAudioBlock.typeToCmp[this._datatype]],this._elCnt.append(s.rootElement),this.resW?this.setResolution(this.resW,this.resH):this.setResolution(s.rootElement.clientWidth,32)),s.render(e,t,i)},_clone(){var e=document.createElement("div");return gsuiAudioBlock.template=gsuiAudioBlock.template||this._init(),e.appendChild(document.importNode(gsuiAudioBlock.template.content,!0)),e.removeChild(e.querySelector("*"))},_init:()=>(document.body.addEventListener("mousemove",function(e){gsuiAudioBlock._focused&&gsuiAudioBlock._focused._evmmBody(e)}),document.body.addEventListener("mouseup",function(e){gsuiAudioBlock._focused&&gsuiAudioBlock._focused._evmuBody(e)}),document.getElementById("gsuiAudioBlock")),_evmdRoot(e){this._isDragging=!0,this.ondrag(this,"down",e),gsuiAudioBlock._focused=this},_evmmBody(e){gsuiAudioBlock._focused&&(this._elCropping?this.oncrop(this,"move",+this._cropSide,e):this._isDragging&&this.ondrag(this,"move",e))},_evmuBody(e){gsuiAudioBlock._focused&&(this._elCropping?(this._elCropping.classList.remove("gsui-hover"),this.oncrop(this,"up",+this._cropSide,e),delete this._elCropping):this._isDragging&&(this.ondrag(this,"up",e),delete this._isDragging),delete gsuiAudioBlock._focused)},_evmdCrop(e){e.stopPropagation(),this._elCropping=e.target,this._cropSide=e.target===this._elCropB,e.target.classList.add("gsui-hover"),this.oncrop(this,"down",+this._cropSide,e),gsuiAudioBlock._focused=this}},window.SVGURL="http://www.w3.org/2000/svg",gsuiBeatLines.prototype={resized(){var e=this.rootElement;this.width=e.getBoundingClientRect().width,e.setAttribute("viewBox","0 0 "+this.width+" 1")},currentTime(e){this._currentTime=e,this._timeUpdate()},offset(e,t){this._offset=Math.max(0,e),this._pxPerBeat=Math.max(0,t),this._render()},timeSignature(e,t){this._beatsPerMeasure=Math.max(1,~~e),this._stepsPerBeat=Math.min(Math.max(1,~~t),16),this._render()},loop(e,t){(this._loop=!1!==e)&&(this._loopA=e,this._loopB=t,this._updateLoop()),this._elLoopA.style.display=this._elLoopB.style.display=this._loop?"block":"none"},render(){this._render()},_render(){for(var e,t,i=this.steps,s=this._pxPerBeat,o=this._stepsPerBeat,n=o*this._beatsPerMeasure,r=s/o,a=1/o,l=0,u=Math.ceil(this.width/r),h=1+~~(this._offset*o),d=-this._offset%a+a;i.length<u;)i.push(this._newRect());for(;l<u;++l)e="gsui-"+(h%n?h%o?"step":"beat":"measure"),(t=i[l]).style.display="block",t.setAttribute("x",d*s+"px"),t.setAttribute("class",e),t.setAttribute("width","gsui-measure"!==e?"1px":"2px"),++h,d+=a;for(;(t=i[l++])&&"none"!==t.style.display;)t.style.display="none";this._timeUpdate(),this._loop&&this._updateLoop()},_newRect(){var e=document.createElementNS(SVGURL,"rect");return e.setAttribute("y",0),e.setAttribute("height","1px"),e.setAttribute("width","1px"),e.style.display="none",this.rootElement.prepend(e),e},_timeUpdate(){var e=this._currentTime-this._offset;this.elTime.style.display=e>0?"block":"none",this.elTime.setAttribute("x",e*this._pxPerBeat+"px")},_updateLoop(){this._elLoopA.setAttribute("width",Math.max(0,this._loopA-this._offset)*this._pxPerBeat+"px"),this._elLoopB.setAttribute("x",(this._loopB-this._offset)*this._pxPerBeat+"px")}},gsuiGridSamples.prototype={empty(){this.uiTrackList&&(this.uiTrackList.empty(),this._rowsById={});for(var e in this._uiBlocks)this._uiBlocks[e].rootElement.remove(),delete this._uiBlocks[e],delete this._uiBlocksSelected[e]},change(e){if(e.tracks)this.uiTrackList.change(e.tracks),this.uiTrackList.newRowElements.forEach(this._rowInit,this);else for(var t in e)e[t]?this._uiBlocks[t]?this._blockUpdate(t,e[t]):this._blockCreate(t,e[t]):this._blockDelete(t)},resized(){var e=getComputedStyle(this._elPanel);this.width=this.rootElement.clientWidth,this._panelMinWidth=parseFloat(e.minWidth),this._panelMaxWidth=parseFloat(e.maxWidth)||this.width,this._resizeGrid(),this._updateGrid()},setFontSize(e){var t=this._fontSize;(e=~~Math.min(Math.max(16,e),256))!==t&&(this._fontSize=e,this.rootElement.style.fontSize=e+"px",e<this._fontSizeTiny!=t<this._fontSizeTiny&&this._elGridCnt.querySelectorAll(".gsui-row").forEach(this._rowUpdateSizeClass,this))},offset(e,t){this._timeOffset=e,this._pxPerBeat=t||this._pxPerBeat,this._updateGrid(!!t)},timeSignature(e,t){this.uiTimeLine.timeSignature(e,t),this.uiBeatLines.timeSignature(e,t)},currentTime(e){this.uiTimeLine.currentTime(e),this.uiBeatLines.currentTime(e)},loop(e,t){this.uiTimeLine.loop(e,t),this.uiBeatLines.loop(e,t)},panelWidth(e){e=Math.max(this._panelMinWidth,Math.min(e,this._panelMaxWidth)),this._timeOffset>0&&(this._timeOffset+=(e-this._panelWidth)/this._pxPerBeat),this._panelWidth=e,this._updatePanelSize()},contentY(e){var t=(this.uiTrackList||this.uiKeys).rootElement.clientHeight;t=Math.max(0,t-this._elGrid.clientHeight)/this._fontSize,this._contentY=e=Math.min(Math.max(0,e),t),this._elGridCnt.style.marginTop=this._elPanelCnt.style.marginTop=-e+"em"},loadKeys(e,t){this._loadPanelCmp("uiKeys","uiTrackList"),this.uiKeys.octaves(e,t),this.uiKeys.newRowElements.forEach(this._rowInit,this)},loadTrackList(){this._loadPanelCmp("uiTrackList","uiKeys"),this.uiTrackList.onchange=(e=>this.onchange({tracks:e}))},_clone(){var e=document.createElement("div");return gsuiGridSamples.template=gsuiGridSamples.template||this._init(),e.appendChild(document.importNode(gsuiGridSamples.template.content,!0)),e.removeChild(e.querySelector("*"))},_init:()=>(document.body.addEventListener("mousemove",function(e){gsuiGridSamples._focused&&gsuiGridSamples._focused._evmmRoot(e)}),document.body.addEventListener("mouseup",function(e){gsuiGridSamples._focused&&gsuiGridSamples._focused._evmuRoot(e)}),document.getElementById("gsuiGridSamples")),_loadPanelCmp(e,t){var i=this[e],s=this[t];s?(s.remove(),this.setFontSize(this._fontSize*("uiKeys"===e?.5:2)),delete this[t]):this.setFontSize("uiKeys"===e?20:40),i||(this[e]=i="uiKeys"===e?new gsuiKeys:new gsuiTrackList,this._elPanelCnt.prepend(i.rootElement))},_resizeGrid(){this.uiTimeLine.resized(),this.uiBeatLines.resized()},_contentScroll(e){this.contentY(this._contentY+20*(e.deltaY>0?1:-1)/this._fontSize)},_getMouseBeat(e){return this._elGridCntBCR=this._elGridCnt.getBoundingClientRect(),this.uiTimeLine._round((e-this._elGridCntBCR.left)/this._pxPerBeat)},_updateGrid(e){var t=this._pxPerBeat;this.uiTimeLine.offset(this._timeOffset,t),this.uiBeatLines.offset(this._timeOffset,t),this._timeOffset=this.uiTimeLine._offset,this._pxPerBeat=t=this.uiTimeLine._pxPerBeat,this._elGridCnt.style.left=-this._timeOffset*t+"px",e&&this._elGridCnt.querySelectorAll(".gsui-row").forEach(this._rowUpdateFontSize,this)},_updatePanelSize(){this._elPanel.style.width=this._elGrid.style.left=this._panelWidth+"px",this.uiTimeLine.rootElement.style.left=this._panelWidth-1+"px",this._resizeGrid(),this._updateGrid()},_findTrack(e){var t=this._elGridCnt.querySelectorAll(".gsui-row"),i=~~((e-this._elGridCntBCR.top)/this._fontSize);return t[Math.max(0,Math.min(i,t.length-1))]},_blockCreate(e,t){var i=new gsuiAudioBlock;return this._uiBlocks[e]=i,i.id=e,i.data=Object.assign({},t),t.key?(i.datatype("key"),i.name(t.key)):i.datatype("keys"),i.ondrag=this._evodBlock.bind(this),i.oncrop=this._evocBlock.bind(this),this.__blockUpdate(e,t),this.fnSampleCreate&&this.fnSampleCreate(e,i),i},_blockUpdate(e,t){var i=this.__blockUpdate(e,t);this.fnSampleUpdate&&this.fnSampleUpdate(e,i)},__blockUpdate(e,t){var i=this._uiBlocks[e];return"when"in t&&i.when(t.when),"duration"in t&&i.duration(t.duration),"selected"in t&&this._blockSelect(e,t.selected),("track"in t||"key"in t)&&(("track"in t?this._rowsById[t.track]:this.rows[this.rows.length-1-this.uiKeys.keyToIndex(t.key)]).firstChild.append(i.rootElement),i.setResolution(t.duration*this._pxPerBeat,this._fontSize)),i},_blockDelete(e){var t=this._uiBlocks[e];t&&(t.rootElement.remove(),delete this._uiBlocks[e],delete this._uiBlocksSelected[e],this.fnSampleDelete&&this.fnSampleDelete(e,t))},_blockSelect(e,t){var i=this._uiBlocks[e];i.select(t),t?this._uiBlocksSelected[e]=i:delete this._uiBlocksSelected[e]},_blockUnselectAll(e){for(var t in this._uiBlocksSelected)e[t]={selected:!1},this._uiBlocksSelected[t].select(!1),delete this._uiBlocksSelected[t];return e},_selectionStarting(e,t,i){Math.max(Math.abs(t),Math.abs(i))>6&&(this._mdTrack=this._mmTrack=this._findTrack(e.pageY),this._selectionCalc(e.pageX),this._elSelection.classList.remove("hidden"),this._selectionIsStarted=!0,delete this._selectionIsStarting)},_selectionStarted(e){this._mmTrack=this._findTrack(e.pageY),this._selectionCalc(e.pageX)},_selectionCalc(e){var t=this._mdTrack,i=this._mmTrack,s=this._getMouseBeat(e),o=this._mdBeat;2&t.compareDocumentPosition(i)&&(t=i,i=this._mdTrack),this._selectionDraw(t,i,Math.min(s,o),Math.max(s,o))},_selectionDraw(e,t,i,s){if(e!==this._selectionTrkA||t!==this._selectionTrkB||i!==this._selectionBeatA||s!==this._selectionBeatB){var o=this._elSelection.style,n=e.getBoundingClientRect().top;this._selectionBeatA=i,this._selectionBeatB=s,this._selectionTrkA=e,this._selectionTrkB=t,o.left=(i-this._timeOffset)*this._pxPerBeat+"px",o.width=(s-i)*this._pxPerBeat+"px",o.top=n-this._elGridCntBCR.top-this._contentY*this._fontSize+"px",o.height=t.getBoundingClientRect().bottom-n+"px",this._selectionSelect()}},_selectionSelect(e,t,i,s){var o,n,r,a,l=this._selectionTrkA,u=this._selectionTrkB,h=this._selectionBeatA,d=this._selectionBeatB,c=this._uiBlocks,p=this._uiBlocksSelected;this._selectionList=[];for(o in c)n=c[o],p[o]||((r=h<n.data.when+n.data.duration&&n.data.when<d)&&(r=2&(a=n.rootElement.compareDocumentPosition(l))||8&a)&&(r=4&(a=n.rootElement.compareDocumentPosition(u))||8&a),r&&this._selectionList.push(n),n.select(r))},_selectionEnd(){this._selectionIsStarted&&(this._elSelection.classList.add("hidden"),delete this._selectionTrkA,delete this._selectionTrkB,delete this._selectionIsStarted,this._selectionList.length>0&&this.onchange(this._selectionList.reduce((e,t)=>(this._uiBlocksSelected[t.id]=t,e[t.id]={selected:!0},e),{}))),delete this._selectionIsStarting},_deletionStarted(e){this._deletionObj=e?{}:this._blockUnselectAll({}),e&&this._deletionPush(e)},_deletionPush(e){e&&(this._deletionObj[e]=null,this._blockDelete(e))},_deletionEnd(){if(this._deletionObj){for(var e in this._deletionObj){this.onchange(this._deletionObj);break}delete this._deletionObj}},_rowInit(e,t){var i,s=this.uiKeys;s&&(i=s._octStart+s._nbOct-1-~~(t/12)),e.onmousedown=this._evmdRow.bind(this,e,i),this._rowsById[e.dataset.track]=e,this._rowUpdateFontSize(e),this._rowUpdateSizeClass(e),this._elGridCnt.append(e)},_rowUpdateFontSize(e){e.firstChild.style.fontSize=this._pxPerBeat+"px"},_rowUpdateSizeClass(e){e.classList.toggle("gs-row-tiny",this._fontSize<this._fontSizeTiny)},_evocCurrentTime(e){this.uiBeatLines.currentTime(e),this.onchangeCurrentTime&&this.onchangeCurrentTime(e)},_evoiLoop(e,t,i){this.uiBeatLines.loop(e&&t,i),this.oninputLoop&&this.oninputLoop(e,t,i)},_evmdGrid(e){this._mdPageX=e.pageX,this._mdPageY=e.pageY,this._mdBeat=this._getMouseBeat(e.pageX),gsuiGridSamples._focused=this,e.shiftKey?this._selectionIsStarting=!0:e.altKey&&(this._gridDragging=!0,this._mouseOffset=this._timeOffset,this._mouseContentY=this._contentY)},_evmdPanelEx(e){this._rootLeft=this.rootElement.getBoundingClientRect().left,this._panelResizing=this._elPanelExt.clientWidth-e.layerX,this._elPanelExt.classList.add("gsui-hover"),gsuiGridSamples._focused=this},_evmdRow(e,t,i){if(!(this._uiBlockClicked||i.shiftKey||i.ctrlKey||i.altKey))if(2===i.button)this._deletionStarted();else if(0===i.button&&this.uiKeys){var s=gsuiGridSamples.getNewId(),o={key:e.dataset.key+t,when:this._getMouseBeat(i.pageX),offset:0,duration:1};this._blockCreate(s,o),this.onchange(this._blockUnselectAll({[s]:o}))}},_evowGrid(e){if(e.shiftKey||e.ctrlKey){var t,i,s=this._pxPerBeat;e.ctrlKey?(t=e.pageX-this._elGrid.getBoundingClientRect().left,s=Math.min(Math.max(8,s*(e.deltaY>0?.9:1.1)),512),i=t/this._pxPerBeat*(s-this._pxPerBeat)/s):i=(e.deltaY>0?20:-20)/s,this.offset(Math.max(0,this._timeOffset+i),e.ctrlKey?s:void 0)}else this._contentScroll(e);return!1},_evowPanel(e){if(e.ctrlKey){var t=e.pageY-this._elPanel.getBoundingClientRect().top,i=this._fontSize,s=i*(e.deltaY>0?.9:1.1);this.setFontSize(s),s=this._fontSize,this.contentY(this._contentY+t/i*(s-i)/s)}else e.shiftKey||this._contentScroll(e);return!1},_evmmRoot(e){var t=e.pageX-this._mdPageX,i=e.pageY-this._mdPageY;this._gridDragging?(this.offset(this._mouseOffset-t/this._pxPerBeat,this._pxPerBeat),this.contentY(this._mouseContentY-i/this._fontSize)):null!=this._panelResizing?this.panelWidth(e.pageX-this._rootLeft+this._panelResizing):this._deletionObj?this._deletionPush(e.target.gsuiAudioBlock&&e.target.gsuiAudioBlock.id):this._selectionIsStarted?this._selectionStarted(e):this._selectionIsStarting&&this._selectionStarting(e,t,i)},_evmuRoot(){this._selectionEnd(),this._deletionEnd(),this._elPanelExt.classList.remove("gsui-hover"),delete this._uiBlockClicked,delete this._gridDragging,delete this._panelResizing,delete gsuiGridSamples._focused},_evkdRoot(e){switch(e.code){case"Delete":this._deletionObj={};for(var t in this._uiBlocksSelected)this._deletionPush(t);this._deletionEnd()}},_evodBlock(e,t,i){if("down"===t)if(this._uiBlockClicked=e,2===i.button)this._deletionStarted(e.id);else if(i.shiftKey){var s=!this._uiBlocksSelected[e.id];this._blockSelect(e.id,s),this.onchange({[e.id]:{selected:s}})}},_evocBlock(e,t,i,s){console.log(t,i)}},gsuiKeys.keyIds={b:11,"a#":10,a:9,"g#":8,g:7,"f#":6,f:5,e:4,"d#":3,d:2,"c#":1,c:0},gsuiKeys.prototype={remove(){this.rootElement.remove(),this.rowElements.forEach(function(e){e.remove()}),this.rowElements.length=0},octaves(e,t){var i,s=this.rootElement,o=t-this._nbOct;if((o||this._octStart!==e)&&(this._octStart=e,s.style.counterReset="octave "+(e+t)),o){if(o>0){for(;o-- >0;)s.append(document.importNode(gsuiKeys.octaveTemplate.content,!0));i=12*this._nbOct,this.newRowElements=s.querySelectorAll(".gsui-row"),this.newRowElements.forEach(function(e){e.remove(),e.dataset.rowid=i++}),Array.prototype.push.apply(this.rowElements,this.newRowElements)}else for(o*=12;o<0;++o)s.lastChild.remove(),this.rowElements[this.rowElements.length-1].remove(),this.rowElements.pop();this._nbOct=t}},keyToIndex(e){var t=e.substr(0,"#"!==e[1]?1:2);return 12*e.substr(t.length)+gsuiKeys.keyIds[t]-12*this._octStart},_init(){gsuiKeys.octaveTemplate||(gsuiKeys.octaveTemplate=document.getElementById("gsuiKeys-octave"),document.body.addEventListener("mousemove",function(e){gsuiKeys._focused&&gsuiKeys._focused._evmmRoot(e)}),document.body.addEventListener("mouseup",function(e){gsuiKeys._focused&&gsuiKeys._focused._evmuRoot(e)}))},_isBlack:e=>1===e||3===e||5===e||8===e||10===e,_keydown(e){var t=this._nlKeys[e];t&&(this._keyup(),this._keyInd=e,this._elKey=t,this._octNum=this._octStart+this._nbOct-1-~~(e/12),t.classList.add("gsui-active"),this.onkeydown&&this.onkeydown(t.dataset.key,this._octNum,this._gain))},_keyup(){this._elKey&&(this._elKey.classList.remove("gsui-active"),this.onkeyup&&this.onkeyup(this._elKey.dataset.key,this._octNum,this._gain))},_evmdRoot(e){if(this._nbOct){var t=this.rootElement.childNodes[1].getBoundingClientRect();this._rootTop=this.rootElement.getBoundingClientRect().top,this._blackKeyR=t.right,this._blackKeyH=t.height,this._gain=Math.min(e.layerX/(e.target.clientWidth-1),1),gsuiKeys._focused=this,this._evmmRoot(e)}},_evmuRoot(e){this._keyup(),delete this._elKey,delete this._keyInd,delete gsuiKeys._focused},_evmmRoot(e){var t=(e.clientY-this._rootTop)/this._blackKeyH,i=~~t;e.clientX>this._blackKeyR&&this._isBlack(~~(i%12))&&(i+=t-i<.5?-1:1),this._keyInd!==i&&this._keydown(i)}},gsuiPanels.prototype={resized(){this._cacheCSS(),this.panels.forEach(this._resizedPan)},axe(e){var t,i="x"===e;i!==this._axeX&&(this._axeX=i,this.rootElement.classList.remove("gsui-axeX","gsui-axeY"),this.rootElement.classList.add("gsui-axe"+(i?"X":"Y")),this._cacheCSS(),this.panels.forEach(function(e){t=e.style.width,e.style.width=e.style.height,e.style.height=t}))},nbPanels(e){var t=[],i=e-this._nbPanels;if(this._nbPanels=e,i<0)for(;i++<0;)t.push(this.rootElement.removeChild(this.rootElement.lastChild)),this._panelDims.pop();else if(i>0)for(;i-- >0;)t.push(this._newPanel(1/e*100));return t},_init(){gsuiPanels._init||(gsuiPanels._init=!0,document.body.addEventListener("mousemove",function(e){gsuiPanels._focused&&gsuiPanels._focused._evmmRoot(e)}),document.body.addEventListener("mouseup",function(e){gsuiPanels._focused&&gsuiPanels._focused._evmuRoot(e)}))},_cacheCSS(){var e=this._axeX,t=this.rootElement.getBoundingClientRect();this._rootSize=(e?t.width:t.height)/100,this.panels.forEach(function(t,i){var s=getComputedStyle(t),o={min:parseFloat(e?s.minWidth:s.minHeight)/this._rootSize,max:parseFloat(e?s.maxWidth:s.maxHeight)/this._rootSize};o.min=o.min||1,o.max=o.max||1/0,i<this._panelDims.length?this._panelDims[i]=o:this._panelDims.push(o)},this)},_newPanel(e){var t=document.createElement("div"),i=document.createElement("div");return t.className="gsui-panel",i.className="gsui-extend",i.onmousedown=this._evmdExtends.bind(this,this.panels.length,t,i),t.append(i),this.rootElement.append(t),t},_resizedPan(e){e.onresize&&e.onresize(e.offsetWidth,e.offsetHeight)},_incPan(e,t,i){var s=this.panels[e],o=this._panelDims[e],n=s[this._axeX?"offsetWidth":"offsetHeight"]/this._rootSize;return t=t<0?-Math.min(-t,n-o.min):Math.min(t,o.max-n),i&&(s.style[this._axeX?"width":"height"]=n+t+"%",this._resizedPan(s)),t},_evmdExtends(e,t,i){this._cacheCSS(),this._panelInd=e,this._elPanel=t,this._elExtend=i,this.rootElement.classList.add("gsui-noselect"),i.classList.add("gsui-hover"),gsuiPanels._focused=this},_evmuRoot(e){this._elExtend&&(this._elExtend.classList.remove("gsui-hover"),delete this._elExtend,delete this._elPanel),this.rootElement.classList.remove("gsui-noselect"),delete gsuiPanels._focused},_evmmRoot(e){if(this._elExtend){var t,i=(this._axeX?e.movementX:e.movementY)/this._rootSize,s=i,o=0,n=this._panelInd;if(i<0){for(;++n<this.panels.length&&i<0;)i+=t=this._incPan(n,-i),o-=t;for(n=this._panelInd,i=o;n>=0&&i<0;--n)i-=this._incPan(n,i,!0);for(n=this._panelInd+1,i=-s+i;n<this.panels.length&&i>0;++n)i-=this._incPan(n,i,!0)}else{for(;n>=0&&i>0;--n)i-=t=this._incPan(n,i),o+=t;for(n=this._panelInd,i=o;i>0&&++n<this.panels.length;)i+=this._incPan(n,-i,!0);for(n=this._panelInd,i=s-i;n>=0&&i>0;--n)i-=this._incPan(n,i,!0)}}}},window.SVGURL="http://www.w3.org/2000/svg",gsuiRectMatrix.prototype={remove(){this.empty(),this.rootElement.remove()},empty(){for(var e=this.rootElement;e.childNodes.length;)e.lastChild.remove()},setResolution(e,t){this.width=e,this.height=t,this.rootElement.setAttribute("viewBox","0 0 "+e+" "+t)},render(e,t,i){var s,o,n,r,a=this.width,l=this.height/e.nbRows,u=this.rootElement;t=t||0,i=i||e.duration,r=a/(i-t),this.empty(),e.samples.forEach(function(e){o=(e.when-t)*r,n=e.duration*r,o+n>0&&o<a&&((s=document.createElementNS(SVGURL,"rect")).setAttribute("x",o+"px"),s.setAttribute("width",n+"px"),s.setAttribute("y",e.row*l+"px"),s.setAttribute("height",l+"px"),u.append(s))})}},gsuiSpanEditable.prototype={setValue(e,t){(e=e?e.trim():"")!==this.value&&(this.value=e,this.rootElement.classList.toggle("gsui-empty",!e),this.span.textContent=e||this.placeholder,t&&this.onchange&&this.onchange(e))},setPlaceholder(e){this.placeholder=e.trim(),this.value||(this.span.textContent=this.placeholder)},_clone(){var e=document.createElement("div"),t=gsuiSpanEditable.template;return gsuiSpanEditable.template=t=t||document.getElementById("gsuiSpanEditable"),e.appendChild(document.importNode(t.content,!0)),e.removeChild(e.querySelector("*"))},_dblclick(e){this.input.value=this.value,this.rootElement.classList.add("gsui-editing"),this.input.focus(),this.input.select()},_blur(e){this._esc||(this.setValue(e.target.value,!0),this.rootElement.classList.remove("gsui-editing")),this._esc=!1},_keydown(e){e.stopPropagation(),13!==e.keyCode&&27!==e.keyCode||(this._esc=27===e.keyCode,this._esc||this.setValue(e.target.value,!0),this.rootElement.classList.remove("gsui-editing"))}},gsuiTimeLine.prototype={resized(){var e=this.rootElement.getBoundingClientRect();this.width=e.width,this.height=e.height},currentTime(e,t){this._currentTime=e,this._updateTime(t),t&&this.onchangeCurrentTime&&this.onchangeCurrentTime(e)},offset(e,t){this._offset=Math.max(0,+e||0),this._pxPerBeat=+t,this._render()},timeSignature(e,t){this._beatsPerMeasure=Math.max(1,~~e),this._stepsPerBeat=Math.min(Math.max(1,~~t),16),this._render()},loop(e,t,i){var s,o,n,r=this._loop;!1===e?this._loop=e:(this._loopA=Math.max(0,Math.min(e,t)),this._loopB=Math.max(0,e,t)),o=this._round(this._loopA),n=this._round(this._loopB),this._loop=n-o>1/this._stepsPerBeat/8,i?this.oninputLoop&&(r&&this._loop&&(s=this._serialAB(o,n)),r===this._loop&&this._loopSerialInp===s||(this._loopSerialInp=s,this.oninputLoop(this._loop,o,n))):(this._loopWas=this._loop,this._loopSerial=this._serialAB(this._loopAWas=o,this._loopBWas=n)),this._updateLoop()},_clone(){var e=document.createElement("div");return gsuiTimeLine.template=gsuiTimeLine.template||this._init(),e.appendChild(document.importNode(gsuiTimeLine.template.content,!0)),e.removeChild(e.querySelector("*"))},_init:()=>(document.body.addEventListener("mousemove",function(e){gsuiTimeLine._focused&&gsuiTimeLine._focused._mousemove(e)}),document.body.addEventListener("mouseup",function(e){gsuiTimeLine._focused&&gsuiTimeLine._focused._mouseup(e)}),document.getElementById("gsuiTimeLine")),_round(e){if(this.stepRound){var t=1/this._stepsPerBeat*this.stepRound;e=Math.round(e/t)*t}return e},_serialAB:(e,t)=>e.toFixed(4)+" "+t.toFixed(4),_mousemove(e){if(this._lock){var t=this._lockA,i=this._lockB,s=this._loopA,o=this._loopB,n=e.movementX/this._pxPerBeat;t||i?(t?s+=n:o+=n,s>o&&(this._lockA=i,this._lockB=t,this._elLoopBrdACL.toggle("gsui-hover",i),this._elLoopBrdBCL.toggle("gsui-hover",t))):(s+n<0&&(n=-s),s+=n,o+=n),this.loop(s,o,!0)}},_mouseup(e){var t,i=this._loop,s=this._round(this._loopA),o=this._round(this._loopB);this._loopA=s,this._loopB=o,this._lock=this._lockA=this._lockB=!1,this._elLoopBgCL.remove("gsui-hover"),this._elLoopBrdACL.remove("gsui-hover"),this._elLoopBrdBCL.remove("gsui-hover"),delete gsuiTimeLine._focused,this.onchangeLoop&&(i?(t=this._serialAB(s,o),this._loopWas===this._loop&&this._loopSerial===t||(this._loopSerial=t,this.onchangeLoop(this._loopWas=i,this._loopAWas=s,this._loopBWas=o))):this._loopWas&&this.onchangeLoop(this._loopWas=i,this._loopAWas,this._loopBWas))},_mousedownTime(e){this.currentTime(this._round(this._offset+e.layerX/this._pxPerBeat),!0)},_mousemoveTime(e){var t=e.layerX/this.width*100;this._elTimeLine.style.backgroundImage="linear-gradient(90deg,transparent "+(t-15)+"%,currentColor "+t+"%,transparent "+(t+15)+"%)"},_mousedownLoop(e){this._lock=!0,this._lockA="a"===e,this._lockB="b"===e,this._elLoopBgCL.toggle("gsui-hover","ab"===e),this._elLoopBrdACL.toggle("gsui-hover",this._lockA),this._elLoopBrdBCL.toggle("gsui-hover",this._lockB),gsuiTimeLine._focused=this},_mousedownLoopLine(e){var t=Date.now(),i=this._offset+e.layerX/this._pxPerBeat;!this._loopClick||t-this._loopClick>500?this._loopClick=t:(this.loop(!1,0,!0),this.loop(i,i,!0),this._mousedownLoop("b"))},_updateTime(e){this._elTime.classList.toggle("gsui-trans",!!e),this._elTime.style.left=(this._currentTime-this._offset)*this._pxPerBeat+"px"},_updateLoop(){var e=this._elLoop.style;if(this._loop){var t=this._pxPerBeat,i=this._offset,s=this._round(this._loopA),o=this._round(this._loopB);e.left=(s-i)*t+"px",e.right=this.width-(o-i)*t+"px"}e.display=this._loop?"block":"none"},_render(){var e,t,i=this.rootElement.classList,s=this._steps,o=this._pxPerBeat,n=this._stepsPerBeat,r=n*this._beatsPerMeasure,a=o/n,l=1/n,u=0,h=Math.ceil(this.width/a+2),d=(this.width,~~(this._offset*n)),c=-this._offset%l;for(i.remove("gsui-step","gsui-beat","gsui-measure"),i.add("gsui-"+(o>24?o>72?"step":"beat":"measure"));s.length<h;)t=document.createElement("div"),s.push(t);for(;u<h;++u)e=d%n,(t=s[u]).style.left=c*o+"px",t.className="gsui-"+(d%r?e?"step":"beat":"measure"),t.textContent="gsui-step"!==t.className?~~(1+d/n):".",t.parentNode||this.rootElement.append(t),++d,c+=l;for(;u<s.length&&(t=s[u]).parentNode;++u)t.remove();this._updateTime(),this._updateLoop()}},gsuiToggle.prototype={check(){this._set(!0)},uncheck(){this._set(!1)},toggle(e){this._set(arguments.length?!!e:!this.checked)},_clone(){var e=document.createElement("div");return gsuiToggle.template=gsuiToggle.template||document.getElementById("gsuiToggle"),e.appendChild(document.importNode(gsuiToggle.template.content,!0)),e.removeChild(e.querySelector("*"))},_set(e,t){e!==this.checked&&(this.checked=e,this._circCL.toggle("gsui-on",e),t&&this.onchange&&this.onchange(e))},_mousedown(e){0===e.button?this._set(!this.checked,!0):2===e.button&&this.onmousedownright&&this.onmousedownright()}},gsuiTrack.prototype={remove(){this.rootElement.remove(),this.rowElement.remove()},change(e){"toggle"in e&&this.toggle(e.toggle),"name"in e&&this.name(e.name)},toggle(e){this._evocToggle(e,!1)},name(e){this._evocSpan(e,!1)},setPlaceholder(e){this.uiSpan.setPlaceholder(e)},_clone(){var e=document.createElement("div");return gsuiTrack.template=gsuiTrack.template||document.getElementById("gsuiTrack"),e.appendChild(document.importNode(gsuiTrack.template.content,!0)),e.removeChild(e.querySelector("*"))},_evocToggle(e,t){this.rootElement.classList.toggle("gsui-mute",!e),this.rowElement.classList.toggle("gsui-mute",!e),!1===t?this.uiToggle.toggle(e):this.onchange({toggle:e}),this.data.toggle=e},_evocSpan(e,t){!1===t?this.uiSpan.setValue(e):this.onchange({name:e}),this.data.name=e}},gsuiTrackList.prototype={remove(){this.empty(),this.rootElement.remove()},empty(){for(var e in this._uiTracks)this._delTrack(e)},change(e){var t,i=[];this.newRowElements=[];for(t in e)i.push({id:t,obj:e[t]});i.sort(function(e,t){return e.obj.order>t.obj.order}),i.forEach(function({id:e,obj:t}){t?(this.data[e]||this._newTrack(e),this._uiTracks[e].change(t)):this._delTrack(e)},this)},_clone(){var e=document.createElement("div");return gsuiTrackList.template||this._init(),e.appendChild(document.importNode(gsuiTrackList.template.content,!0)),e.removeChild(e.querySelector("*"))},_init(){gsuiTrackList.template=document.getElementById("gsuiTrackList")},_newTrack(e){var t=new gsuiTrack;t.uiToggle.onmousedownright=this._muteAll.bind(this,e),t.onchange=this._evocTrack.bind(this,e),t.setPlaceholder("Track "+(this.rootElement.childNodes.length+1)),t.rootElement.dataset.track=t.rowElement.dataset.track=e,this.data[e]=t.data,this._uiTracks[e]=t,this.rootElement.append(t.rootElement),this.newRowElements.push(t.rowElement)},_delTrack(e){this._uiTracks[e].remove(),delete this._uiTracks[e],delete this.data[e]},_evocTrack(e,t){this.onchange({[e]:t})},_muteAll(e){var t,i,s={},o=this._uiTracks,n=o[e],r=!0;for(e in o)if((t=o[e]).data.toggle&&t!==n){r=!1;break}for(e in o)t=o[e],(i=r||t===n)!==t.data.toggle&&(t.toggle(i),s[e]={toggle:i});this.onchange(s)}},window.common={},window.gs={},window.ui={},window.settings={def_bpm:120,def_beatsPerMeasure:4,def_stepsPerBeat:4,def_nbTracks:21,clockSteps:!1,audioFileExt:["mp3","wav","ogg"]},common.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},common.trim2=function(e){return e.trim().replace(/\s+/g," ")},common.nameUnique=function(e,t){var i,s,o;return e=common.trim2(e),t.indexOf(e)>-1?(i=new RegExp("^"+e+" \\((\\d+)\\)$"),o=t.reduce(function(e,t){return(s=i.exec(t))?Math.max(e,+s[1]):e},1),`${e} (${o+1})`):e},common.timestampText=function(e,t){var i,s,o;return t?(i=1+~~(e*=t/60),s=1+~~(e*=4)%4):(i=~~(e/60),s=~~(e%60)),s=s<10?"0"+s:s,(o=Math.floor(1e3*(e-~~e)))<10?o="00"+o:o<100&&(o="0"+o),{a:i,b:s,c:o}},common.composeUndo=function(e,t){if(e&&t&&"object"==typeof e&&"object"==typeof t){var i,s={};for(i in t)e[i]!==t[i]&&(s[i]=common.composeUndo(e[i],t[i]));return s}return e},common.assignDeep=function(e,t){if(e&&t&&"object"==typeof e&&"object"==typeof t){var i,s;for(i in t)null!=(s=common.assignDeep(e[i],t[i]))?e[i]=s:delete e[i];return e}return t},gs.init=function(){ui.init(),gs.history=[],gs.historyInd=0,gs.currCmp=null,gs.currCmpSaved=!0,gs.localStorage.getAll().forEach(function(e){ui.cmps.push(e.id),ui.cmps.update(e.id,e)})},gs.undo=function(){if(gs.historyInd>0){var e=gs.history[--gs.historyInd],t=gs.history[gs.historyInd-1];gs.currCmpSaved=!!(t?t.saved:!gs.historyActionSaved&&(gs.currCmp.savedAt||localStorage[gs.currCmp.id])),gs.changeComposition(e.undo),ui.history.undo(e),ui.cmps.saved(gs.currCmpSaved)}},gs.redo=function(){if(gs.historyInd<gs.history.length){var e=gs.history[gs.historyInd++];gs.currCmpSaved=!!e.saved,gs.changeComposition(e.redo),ui.history.redo(e),ui.cmps.saved(gs.currCmpSaved)}},gs.localStorage={put(e,t){localStorage[e]=JSON.stringify(t)},delete(e){delete localStorage[e]},get(e){try{var t=JSON.parse(localStorage[e]);return e===t.id&&t.stepsPerBeat?t:null}catch(e){return null}},getAll(){var e,t,i=[];for(e in localStorage)(t=gs.localStorage.get(e))&&i.push(t);return i.sort(function(e,t){return e.savedAt<t.savedAt}),i}},gs.changeSettings=function(e){settings.clockSteps=e.clockSteps,ui.controls.clock(gs.currentTime())},gs.loadComposition=function(e){return gs.unloadComposition().then(function(){var t,i=gs.localStorage.get(e.id);gs.currCmp=e,gs.currCmpSaved=!(!e.savedAt||!i||i.savedAt!==e.savedAt),null!=e.savedAt&&i||(ui.cmps.push(e.id),ui.cmps.update(e.id,e));for(t in e.patterns)ui.patterns.change(t,e.patterns[t]),gs.updatePatternContent(t);ui.controls.currentTime(0),ui.controls.bpm(e.bpm),ui.mainGrid.empty(),ui.mainGridSamples.timeSignature(e.beatsPerMeasure,e.stepsPerBeat),ui.keysGridSamples.timeSignature(e.beatsPerMeasure,e.stepsPerBeat),ui.mainGrid.change(e),ui.cmps.load(e.id),ui.cmps.saved(!gs.isCompositionNeedSave()),e.patternOpened&&ui.patterns.open(e.patternOpened)})},gs.loadNewComposition=function(){for(var e=0,t={};e<settings.def_nbTracks;++e)t[common.uuid()]={order:e,toggle:!0,name:""};return gs.loadComposition({id:common.uuid(),bpm:settings.def_bpm,stepsPerBeat:settings.def_stepsPerBeat,beatsPerMeasure:settings.def_beatsPerMeasure,name:"",duration:0,tracks:t,patterns:{},blocks:{},keys:{}}).then(function(){ui.patterns.open(gs.newPattern(!1))},function(){console.log(arguments)})},gs.loadCompositionById=function(e){var t=gs.localStorage.get(e);return(t?gs.loadComposition(t):gs.loadNewComposition()).then(function(){},function(){console.log(arguments)})},gs.loadCompositionByBlob=function(e){return new Promise(function(t,i){var s,o=new FileReader;o.onload=function(){try{s=JSON.parse(o.result)}catch(e){return void i()}gs.loadComposition(s).then(t,i)},o.readAsText(e)})},gs.pushCompositionChange=function(e){var t={redo:e,undo:common.composeUndo(gs.currCmp,e)};gs.historyInd<gs.history.length&&(gs.history.length=gs.historyInd,ui.history.cut(gs.historyInd)),gs.historyInd=gs.history.push(t),gs.currCmpSaved=!1,gs.changeComposition(e),ui.history.push(t),ui.cmps.saved(!1)},gs.changeComposition=function(e){var t,i,s=gs.currCmp,o=e.beatsPerMeasure,n=e.stepsPerBeat;common.assignDeep(s,e),ui.mainGrid.change(e);for(i in e.patterns)ui.patterns.change(i,e.patterns[i]);for(t in e.keys)for(i in s.patterns)if(s.patterns[i].keys===t){gs.updatePatternContent(i),i===s.patternOpened&&ui.keysGridSamples.change(e.keys[t]);break}if(e.bpm&&ui.controls.bpm(e.bpm),o||n){ui.mainGridSamples.timeSignature(s.beatsPerMeasure,s.stepsPerBeat),ui.keysGridSamples.timeSignature(s.beatsPerMeasure,s.stepsPerBeat);for(i in s.patterns)gs.updatePatternContent(i)}(null!=e.name||e.bpm)&&ui.cmps.update(s.id,s)},gs.unloadComposition=function(){return new Promise(function(e,t){var i,s=gs.currCmp;s?(gs.currCmpSaved||gs.history.length&&!confirm("Are you sure to discard the unsaved change ?")||(gs.currCmpSaved=!0,(i=gs.localStorage.get(s.id))?(ui.cmps.saved(!0),ui.cmps.update(s.id,i)):ui.cmps.remove(s.id)),gs.currCmpSaved?(gs.historyInd=0,gs.history.length=0,ui.history.cut(0),ui.controls.currentTime(0),ui.cmps.unload(),ui.patterns.empty(),ui.pattern.empty(),gs.currCmp=null,e()):t()):e()})},gs.deleteComposition=function(e){var t,i=e===gs.currCmp.id,s=`Are you sure about deleting "${(i?gs.currCmp:gs.localStorage.get(e)).name}" ? (no undo possible)`;confirm(s)&&(gs.localStorage.delete(e),ui.cmps.remove(e),i&&(gs.currCmpSaved=!0,(t=gs.localStorage.getAll()[0])?gs.loadCompositionById(t.id):gs.loadNewComposition()))},gs.isCompositionNeedSave=function(){return!gs.currCmpSaved&&(gs.currCmp.savedAt||gs.history.length)},gs.saveCurrentComposition=function(){return gs.currCmpSaved?Promise.resolve():new Promise(function(e,t){var i=gs.currCmp;i.savedAt=~~(Date.now()/1e3),gs.localStorage.put(i.id,i),gs.historyActionSaved&&delete gs.historyActionSaved.saved,(gs.historyActionSaved=gs.history[gs.historyInd-1])&&(gs.historyActionSaved.saved=!0),gs.currCmpSaved=!0,ui.cmps.saved(!0),e()})},gs.exportCompositionJSON=function(e){var t=e===gs.currCmp.id?gs.currCmp:gs.localStorage.get(e),i=new Blob([JSON.stringify(t)]);ui.downloadBlob((t.name||"untitled")+".gs",i)},gs.exportCompositionWAV=function(e){e!==gs.currCmp.id&&alert("You have to open a composition before render it.")},gs.newPattern=function(e){var t=common.uuid(),i=common.uuid();return(!1===e?gs.changeComposition:gs.pushCompositionChange)({keys:{[t]:{}},patterns:{[i]:{name:gs.namePattern("pat"),type:"keys",keys:t,duration:gs.currCmp.beatsPerMeasure}}}),i},gs.removePattern=function(e){var t,i,s=gs.currCmp.blocks,o={},n={keys:{[gs.currCmp.patterns[e].keys]:null},patterns:{[e]:null}};for(t in s)s[t].pattern===e&&(o[t]=null,i=!0);i&&(n.blocks=o),gs.pushCompositionChange(n)},gs.namePattern=function(e){var t=gs.currCmp.patterns,i=Object.keys(t).map(function(e){return t[e].name});return common.nameUnique(e,i)},gs.dropPattern=function(e,t,i){var s=gs.currCmp;gs.pushCompositionChange({blocks:{[common.uuid()]:{pattern:e,track:t,when:i,offset:0,duration:s.patterns[e].duration}}})},gs.updatePatternContent=function(e){var t,i,s,o=gs.currCmp.patterns[e],n=gs.keysToRects(gs.currCmp.keys[o.keys]),r=n.duration;if(o.duration!==r){o.duration=r,t=gs.currCmp.blocks;for(s in t)(i=t[s]).durationEdited||(i.duration=r)}ui.patterns.updateContent(e,n)},gs.addAudioFiles=function(e){lg("addAudioFiles()",e),e.forEach(function(e){})},gs.keysToRects=function(e){var t,i,s,o,n=1/0,r=-1/0,a=0,l=[],u=gs.currCmp;for(t in e)i=e[t],s=ui.keysGridSamples.uiKeys.keyToIndex(i.key),n=Math.min(n,s),r=Math.max(r,s),a=Math.max(a,i.when+i.duration),l.push({row:s,when:i.when,duration:i.duration});return o=r-n,l.forEach(function(e){e.row=o-(e.row-n)}),{nbRows:o+1,samples:l,duration:Math.max(1,Math.ceil(a/u.beatsPerMeasure))*u.beatsPerMeasure}},ui.init=function(){var e,t,i=new gsuiPanels,s=new gsuiPanels,o=new gsuiPanels,n={app:document.getElementById("app"),appContent:document.getElementById("appContent")};gsuiGridSamples.getNewId=common.uuid,ui.panelsMain=i,s.axe("y"),o.axe("y"),i.nbPanels(2),s.nbPanels(3),o.nbPanels(2),i.rootElement.id="panelsMain",i.panels[0].id="panelsLeftWrap",s.rootElement.id="panelsLeft",o.rootElement.id="panelsRight",i.panels[0].append(s.rootElement),i.panels[1].append(o.rootElement),n.app.append(i.rootElement),e=n.app.querySelectorAll(".gsui-panel"),i.resized(),s.resized(),o.resized(),i.panels[1].onresize=function(e,t){ui.mainGridSamples.resized(),ui.keysGridSamples.resized()},(t=document.importNode(n.appContent.content,!0)).querySelectorAll("[data-panel]").forEach(function(t){e[t.dataset.panel].append(t)}),n.app.append(t.querySelector("#settingsPopupWrap")),ui.idElements=n,document.querySelectorAll("[id]").forEach(function(e){n[e.id]=e}),ui.cmps.init(),ui.history.init(),ui.patterns.init(),ui.pattern.init(),ui.mainGrid.init(),ui.settingsPopup.init(),ui.windowEvents()},ui.downloadBlob=function(e,t){var i=document.createElement("a"),s=URL.createObjectURL(t);i.download=e,i.href=s,i.click(),URL.revokeObjectURL(s)},ui.windowEvents=function(){window.onresize=function(){ui.panelsMain.resized()},window.onbeforeunload=function(){if(gs.isCompositionNeedSave())return"Data unsaved"},window.onkeydown=function(e){if(e.ctrlKey){switch(e.code){case"KeyS":gs.saveCurrentComposition();break;case"KeyZ":e.shiftKey?gs.redo():gs.undo();break;default:return}e.preventDefault()}else"Escape"===e.code&&ui.settingsPopup.hide()},document.body.onclick=function(e){ui.cmps._hideMenu()},document.body.ondrop=function(e){var t,i=Array.from(e.dataTransfer.files).filter(function(e){var i=e.name.substr(e.name.lastIndexOf(".")+1).toLowerCase();return"gs"===i&&(t=e),settings.audioFileExt.indexOf(i)>-1});return t?gs.loadCompositionByBlob(t).then(gs.addAudioFiles.bind(null,i),function(){}):gs.addAudioFiles(i),!1},document.body.ondragover=function(){return!1}},ui.history={init(){},undo(e){e._html.classList.add("undone")},redo(e){e._html.classList.remove("undone")},cut(e){for(var t=ui.idElements.history.childNodes;e<t.length;)t[t.length-1].remove()},push(e){var t=document.createElement("div"),i=document.createElement("span"),s=document.createElement("span"),o=ui.history._nameAction(e);e._html=t,t.className="action",i.className="actionIcon "+o.i,s.className="actionText",s.textContent=o.t,t.append(i,s),t.onclick=ui.history._onclick,ui.idElements.history.append(t),ui.idElements.history.scrollTop=1e7},_onclick(e){var t=e.target,i=t.classList.contains("action")?t:t.parentNode,s=Array.from(ui.idElements.history.childNodes).lastIndexOf(i)-gs.historyInd+1;if(s<0)for(;s++<0;)gs.undo();else if(s>0)for(;s-- >0;)gs.redo()},_nameAction(e){var t=gs.currCmp,i=e.redo,s=e.undo;return ui.history.__pattern(t,i,s)||ui.history.__tracks(t,i,s)||ui.history.__blocks(t,i,s)||ui.history.__keys(t,i,s)||(null!=i.name?{i:"name",t:`Name: "${i.name}"`}:i.bpm?{i:"clock",t:`BPM: ${i.bpm}`}:i.beatsPerMeasure||i.stepsPerBeat?{i:"clock",t:`Time signature: ${t.beatsPerMeasure}/${t.stepsPerBeat}`}:{i:"",t:""})},__blocks(e,t,i){var s,o,n,r=t.blocks;for(s in r)return n=Object.keys(r),o=" "+n.length+" sample"+(n.length>1?"s":""),r[s]?i.blocks[s]?{i:"name",t:"edit"+o}:{i:"paint",t:"add"+o}:{i:"erase",t:"remove"+o}},__tracks(e,t,i){var s,o=0,n=t.tracks;if(n){for(s in n){if(n[s].name)return{i:"name",t:`Name track: "${i.tracks[s].name}" -> "${n[s].name}"`};if(o++)break}return o>1?{i:"unmute",t:`Un/mute several tracks`}:{i:n[s].toggle?"unmute":"mute",t:(n[s].toggle?"Unmute":"Mute")+` "${e.tracks[s].name}" track`}}},__pattern(e,t,i){var s,o,n;for(s in t.patterns){if(o=t.patterns[s],n=i.patterns[s],!o||!n)return o?{i:"add",t:`New pattern "${o.name}"`}:{i:"remove",t:`Remove pattern "${n.name}"`};if("name"in o)return{i:"name",t:`${n.name}: rename to "${o.name}"`}}},__keys(e,t,i){var s,o,n,r,a,l;for(o in t.keys){s=t.keys[o];for(n in s)return r=Object.keys(s),l=e.patterns[e.patternOpened].name+": ",a=" "+r.length+" sample"+(r.length>1?"s":""),!(s=s[n])&&{i:"erase",t:l+"remove"+a}||!i.keys[o][n]&&{i:"paint",t:l+"add"+a}||"selected"in s&&(s.selected?{i:"selection plus",t:l+"select"+a}:{i:"selection minus",t:l+"unselect"+a})}}},ui.controls={play(){ui.idElements.play.classList.remove("pause")},pause(){ui.idElements.play.classList.add("pause")},stop(){ui.controls.play()},bpm(e){ui.idElements.bpmNumber.textContent=e},currentTime(e){ui.controls.clock(e)},clock(e){var t=common.timestampText(e,settings.clockSteps&&gs.currCmp.bpm);ui.idElements.clockMin.textContent=t.a,ui.idElements.clockSec.textContent=t.b,ui.idElements.clockMs.textContent=t.c},title(e){document.title=(gs.isCompositionNeedSave()?"*":"")+(e||"GridSound")}},ui.mainGrid={init(){var e=new gsuiGridSamples,t=e.rootElement.querySelector(".gsuigs-grid .gsuigs-content");e.loadTrackList(),e.offset(0,40),e.onchange=ui.mainGrid._onchangeGrid,e.fnSampleCreate=function(e,t){var i=gs.currCmp,s=i.patterns[t.data.pattern];ui.mainGrid.blocks[e]=t,t.name(s.name),t.updateData(gs.keysToRects(i.keys[s.keys]))},e.fnSampleDelete=function(e,t){delete ui.mainGrid.blocks[e]},ui.idElements.mainGridWrap.append(e.rootElement),ui.mainGridSamples=e,ui.mainGrid.elGridCnt=t,ui.mainGrid.blocks={},t.ondrop=ui.mainGrid._ondrop,t.ondragenter=function(e){e.dataTransfer.dropEffect="copy"},ui.mainGrid.uiBlocks={},e.resized()},empty(){ui.mainGridSamples.empty(),ui.mainGrid.uiBlocks={}},change(e){e.tracks&&ui.mainGridSamples.change(e),e.blocks&&ui.mainGridSamples.change(e.blocks)},getPatternBlocks(e){var t,i=[],s=ui.mainGrid.blocks;for(t in s)s[t].data.pattern===e&&i.push(s[t]);return i},_onchangeGrid(e){gs.pushCompositionChange({blocks:e})},_ondrop(e){var t=e.target,i=(e.dataTransfer.getData("text"),ui.mainGridSamples),s=i.rootElement.getBoundingClientRect(),o=e.pageX-s.left-i._panelWidth;for(e.stopPropagation();!t.classList.contains("gsui-row");)t=t.parentNode;return gs.dropPattern(e.dataTransfer.getData("text"),t.dataset.track,i.uiTimeLine._round(o/i._pxPerBeat+i._timeOffset)),!1}},ui.cmps={init(){ui.idElements.cmpMenu.onclick=ui.cmps._clickMenu},push(e){var t=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div"),r=document.createElement("span"),a=document.createElement("span");t.className="cmp",i.className="save",s.className="info",o.className="menu",n.className="name",r.className="bpm",a.className="duration",s.append(n,r,a),t.append(i,s,o),i.onclick=gs.saveCurrentComposition,s.onclick=gs.loadCompositionById.bind(null,e),o.onclick=ui.cmps._showMenu.bind(null,e),ui.cmps._html[e]={root:t,name:n,bpm:r,duration:a},ui.idElements.cmps.append(t)},remove(e){ui.cmps._html[e].root.remove(),delete ui.cmps._html[e]},update(e,t){var i=ui.cmps._html[e],s=common.timestampText(t.duration);i.name.textContent=t.name,ui.controls.title(t.name),i.bpm.textContent=t.bpm,i.duration.textContent=s.a+":"+s.b},load(e){var t=ui.cmps._html[e];ui.cmps._loadOne=t,t.root.classList.add("loaded"),ui.controls.title(gs.currCmp.name),ui.idElements.cmps.prepend(t.root)},saved(e){ui.controls.title(gs.currCmp.name),ui.cmps._loadOne.root.classList.toggle("notSaved",!e)},unload(){ui.cmps._loadOne.root.classList.remove("loaded"),delete ui.cmps._loadOne},_html:{},_showMenu(e,t){var i=t.target.parentNode.getBoundingClientRect();ui.cmps._cmpId=e,ui.idElements.cmpMenu.style.top=i.top+(i.bottom-i.top)/2+"px",ui.idElements.cmpMenu.classList.remove("hidden"),t.stopPropagation()},_hideMenu(){delete ui.cmps._cmpId,ui.idElements.cmpMenu.classList.add("hidden")},_clickMenu(e){gs[e.target.id](ui.cmps._cmpId),ui.cmps._hideMenu(),e.stopPropagation()}},ui.patterns={init(){ui.patterns.audioBlocks={},ui.idElements.patNew.onclick=gs.newPattern,ui.idElements.patRemove.onclick=ui.patterns._onclickRemove},empty(){for(var e in ui.patterns.audioBlocks)ui.patterns._remove(e)},change(e,t){t?ui.patterns.audioBlocks[e]?ui.patterns._update(e,t):ui.patterns._add(e,t):ui.patterns._remove(e)},open(e){var t,i=gs.currCmp;i.patternOpened=e,t=i.patterns[e],ui.patterns.select(e),ui.pattern.name(t.name),ui.pattern.load(i.keys[t.keys])},select(e){var t=ui.patterns._selectedPattern,i=ui.patterns.audioBlocks[e];t&&t.rootElement.classList.remove("selected"),ui.patterns._selectedPattern=i,i.rootElement.classList.add("selected")},updateContent(e,t){ui.patterns.audioBlocks[e].updateData(t),ui.mainGrid.getPatternBlocks(e).forEach(function(e){gs.currCmp.blocks[e.id].durationEdited||e.duration(t.duration),e.updateData(t)})},_add(e,t){var i=new gsuiAudioBlock,s=i.rootElement;i.data=t,i.name(t.name),i.datatype("keys"),i.ondrag=function(){},s._patId=e,s.setAttribute("draggable","true"),s.ondragstart=ui.patterns._ondragstartPattern.bind(null,e),s.ondblclick=ui.patterns._ondblclickPattern.bind(null,e),ui.patterns.audioBlocks[e]=i,ui.idElements.patterns.prepend(s),ui.patterns.open(e)},_remove(e){var t,i=ui.patterns.audioBlocks[e].rootElement;e===gs.currCmp.patternOpened&&(delete gs.currCmp.patternOpened,(t=i.nextSibling||i.previousSibling)&&ui.patterns.open(t._patId)),delete ui.patterns.audioBlocks[e],i.remove()},_update(e,t){var i;ui.mainGrid.getPatternBlocks(e);"name"in t&&(i=t.name,ui.patterns.audioBlocks[e].name(i),ui.mainGrid.getPatternBlocks(e).forEach(function(e){e.name(i)}),e===gs.currCmp.patternOpened&&ui.pattern.name(i))},_onclickRemove(){var e=gs.currCmp.patternOpened,t=ui.patterns.audioBlocks[e].rootElement;(t.nextSibling||t.previousSibling)&&gs.removePattern(e)},_ondblclickPattern(e){e!==gs.currCmp.patternOpened&&ui.patterns.open(e)},_ondragstartPattern(e,t){t.dataTransfer.setData("text",e)}},ui.pattern={init(){var e=new gsuiGridSamples;e.loadKeys(4,3),e.offset(0,120),e.setFontSize(20),ui.idElements.keysGridWrap.append(e.rootElement),ui.idElements.patternName.onclick=ui.pattern._onclickPatternName,e.onchange=ui.pattern._onchangeGrid,e.resized(),ui.keysGridSamples=e},empty(){ui.pattern.name(""),ui.keysGridSamples.empty()},name(e){ui.idElements.patternName.textContent=e},load(e){ui.keysGridSamples.empty(),ui.keysGridSamples.change(e)},_onchangeGrid(e){gs.pushCompositionChange({keys:{[gs.currCmp.patterns[gs.currCmp.patternOpened].keys]:e}})},_onclickPatternName(){var e=gs.currCmp.patternOpened,t=gs.currCmp.patterns[e],i=prompt("Name pattern :",t.name);null!=i&&(i=i.trim())!==t.name&&gs.pushCompositionChange({patterns:{[e]:{name:i}}})}},ui.settingsPopup={init(){ui.idElements.settings.onclick=ui.settingsPopup.show,ui.idElements.settingsPopupWrap.onclick=ui.settingsPopup.hide,ui.idElements.settingsPopupForm.onsubmit=ui.settingsPopup._onsubmit,ui.idElements.settingsPopup.onclick=function(e){e.stopPropagation()},ui.settingsPopup.inputs=ui.idElements.settingsPopupForm.querySelectorAll("input")},show(){var e=ui.settingsPopup.inputs;e[+settings.clockSteps].checked=!0,e[2].value=gs.currCmp.name,e[3].value=gs.currCmp.bpm,e[4].value=gs.currCmp.beatsPerMeasure,e[5].value=gs.currCmp.stepsPerBeat,ui.idElements.settingsPopupWrap.classList.remove("hidden")},hide(){ui.idElements.settingsPopupWrap.classList.add("hidden")},_onsubmit(){var e,t={},i={},s=gs.currCmp,o=ui.settingsPopup.inputs;o[+settings.clockSteps].checked||(t.clockSteps=!settings.clockSteps),(e=o[2].value)!==s.name&&(i.name=e),(e=+o[3].value)!==s.bpm&&(i.bpm=e),(e=+o[4].value)!==s.beatsPerMeasure&&(i.beatsPerMeasure=e),(e=+o[5].value)!==s.stepsPerBeat&&(i.stepsPerBeat=e);for(e in t){gs.changeSettings(t);break}for(e in i){gs.pushCompositionChange(i);break}return ui.settingsPopup.hide(),!1}},gs.init(),gs.loadNewComposition();
</script>
</html>
