"use strict";function gswaContext(){this.ctx=new window.AudioContext,this.destination=this.ctx.destination,this.filters=this.createFilters(),this.nbPlaying=0,this.filters.connect(this.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}function gswaSample(t,i){this.wCtx=t,this.wBuffer=i,this.connectedTo=t.nodeIn,this.started=0,this.bufferSources=[],this.onended(function(){}),this.edit(0,0,i.duration),this.bufferDuration=i.duration}function gswaSampleGroup(){this.samples=[],this.samplesRev=[],this.updateDuration()}function gswaBuffer(t){this.wCtx=t,this.samples=[],this.sample=new gswaSample(t,this)}function gswaFilters(t){this.wCtx=t,this.nodes=[],this.nodeIn=t.ctx.createGain(),this.nodeOut=t.ctx.createGain(),this.nodeIn.connect(this.nodeOut),this.connect(t)}function gswaComposition(t){this.wCtx=t,this.samples=[],this.isPlaying=this.isPaused=!1,this.oldDuration=this.duration=this._startedTime=this._currentTime=0,this._bpm=60,this.fnOnended=this.fnOnpaused=function(){},this.onended=this.onended.bind(this),this._add=this._add.bind(this),this._remove=this._remove.bind(this)}gswaContext.prototype={gain:function(t){return arguments.length?(this.filter.gain(t),this):this.filter.gain()},createSample:function(t){var i=new gswaSample(this,t);return t.samples.push(i),i},createBuffer:function(){return new gswaBuffer(this)},createFilters:function(){return new gswaFilters(this)},createComposition:function(){return new gswaComposition(this)}},function(){function t(t,i){for(var n=0,e=0,s=t.length+i.length,o=new Float32Array(s);n<s;)o[n++]=t[e],o[n++]=i[e++];return o}function i(t,i,n){for(var e=0;e<n.length;++e)t.setUint8(i+e,n.charCodeAt(e))}function n(t,i,n){for(var e,s=0;s<n.length;++s,i+=2)e=Math.max(-1,Math.min(n[s],1)),t.setInt16(i,e<0?32768*e:32767*e,!0)}function e(t,i,n){for(var e=0;e<n.length;++e,i+=4)t.setFloat32(i,n[e],!0)}window.gswaEncodeWAV=function(s,o){var h=s.numberOfChannels,r=s.sampleRate,a=o&&o.float32?3:1,u=3===a?32:16,c=u/8,d=h*c,l=2===h?t(s.getChannelData(0),s.getChannelData(1)):s.getChannelData(0),f=new ArrayBuffer(44+l.length*c),p=new DataView(f);return i(p,0,"RIFF"),p.setUint32(4,36+l.length*c,!0),i(p,8,"WAVE"),i(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,a,!0),p.setUint16(22,h,!0),p.setUint32(24,r,!0),p.setUint32(28,r*d,!0),p.setUint16(32,d,!0),p.setUint16(34,u,!0),i(p,36,"data"),p.setUint32(40,l.length*c,!0),(1===a?n:e)(p,44,l),f}}(),gswaSample.prototype={edit:function(t,i,n){return null!=t&&(this.when=t),null!=i&&(this.offset=i),null!=n&&(this.duration=n),this},connect:function(t){return t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.bufferSources.forEach(function(i){i.connect(t)})),this},disconnect:function(){return this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()}),this},start:function(t,i,n){if(this.wBuffer.buffer){var e=this.wCtx.ctx.createBufferSource();t=null!=t?t:this.when,i=null!=i?i:this.offset,n=null!=n?n:this.duration,e.buffer=this.wBuffer.buffer,e.onended=this._bsrcOnended.bind(this,e,!0),e.connect(this.connectedTo),this.bufferSources.push(e),e.start(this.wCtx.ctx.currentTime+t,i,n),++this.started,t>0?e.gs__onplayTimeoutId=setTimeout(this._bsrcOnplay.bind(this,e),1e3*t):this._bsrcOnplay(e)}return this},stop:function(){return this.started&&(this.bufferSources.forEach(function(t){t.onended=null,t.stop(0),this._bsrcOnended(t,!1)},this),this.bufferSources.length=0),this},onended:function(t){return this._userOnended=t,this},_bsrcOnplay:function(t){t.gs__isPlaying=!0,++this.wCtx.nbPlaying},_bsrcOnended:function(t,i){clearTimeout(t.gs__onplayTimeoutId),t.gs__isPlaying&&(t.gs__isPlaying=!1,--this.wCtx.nbPlaying),i&&this.bufferSources.splice(this.bufferSources.indexOf(t),1),--this.started,this._userOnended()}},gswaSampleGroup.prototype={stretch:function(t){this.samples.forEach(function(i){i.whenRel*=t}),this.updateDuration()},start:function(t,i,n){t=t||0,i=i||0,n=arguments.length>2?n:this.duration,this.samples.forEach(function(e){var s=e.whenRel-i,o=e.duration,h=e.offset;s<0&&(h-=s,o+=s),o>0&&(o+=Math.min(n-s-o,0),o>0&&e.sample.start(t+s,h,o))})},stop:function(){this.samples.forEach(function(t){t.sample.stop()})},addSample:function(t){t.offset=t.offset||0,t.duration=t.duration||t.sample.duration,this.samples.push(t),this.samplesRev.push(t)},addSamples:function(t){t.forEach(this.addSample.bind(this))},delSample:function(t){function i(i){i.splice(i.findIndex(function(i){return i===t}),1)}i(this.samples),i(this.samplesRev)},delSamples:function(t){t.forEach(this.delSample.bind(this))},updateDuration:function(){this.duration=this.samplesRev.length&&this.samplesRev[0].duration},updateAllSamples:function(){function t(t,i){return t<i?1:t>i?-1:0}this.samples.sort(function(i,n){return t(i.whenRel,n.whenRel)}),this.samplesRev.sort(function(i,n){return t(n.whenRel+n.duration,i.whenRel+i.duration)})}},gswaBuffer.prototype={setFile:function(t){var i=this;return new Promise(function(n,e){function s(t){i.wCtx.ctx.decodeAudioData(t,function(t){i._setData(t),n(i)},e)}if(t.name){var o=new FileReader;o.addEventListener("loadend",function(){s(o.result)}),o.readAsArrayBuffer(t)}else s(t)})},_setData:function(t){this.buffer=t,this._setDuration(t.duration)},_setDuration:function(t){function i(i){i.bufferDuration=t,(null==i.duration||i.duration>t)&&(i.duration=t)}this.duration=t,this.samples.forEach(i),i(this.sample)},getPeaks:function(t,i,n,e){n=n||0,e=void 0===e?this.buffer.duration-n:Math.min(e,this.buffer.duration-n);for(var s,o,h,r=0,a=new Array(i),u=this.buffer.getChannelData(t),c=e*this.buffer.sampleRate,d=n*this.buffer.sampleRate,l=c/i,f=~~Math.max(1,l/10);r<i;++r){for(s=d+r*l,o=s+l,h=0;s<o;s+=f)h=Math.max(h,Math.abs(u[~~s]));a[r]=h}return a}},gswaFilters.prototype={connect:function(t){t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.nodeOut.connect(t))},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},empty:function(){this.nodes.length&&(this.nodes[this.nodes.length-1].disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[])},gain:function(t){return arguments.length?void(this.nodeOut.gain.value=t):this.nodeOut.gain.value},pushBack:function(t){if(this.nodes.length){var i=this.nodes[this.nodes.length-1];i.disconnect(),i.connect(t)}else this.nodeIn.disconnect(),this.nodeIn.connect(t);t.connect(this.nodeOut),this.nodes.push(t)},pushFront:function(t){this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(t),t.connect(this.nodes[0]),this.nodes.unshift(t)):this.pushBack(t)},popBack:function(){var t=this.nodes.pop();if(t)if(t.disconnect(),this.nodes.length){var i=this.nodes[this.nodes.length-1];i.disconnect(),i.connect(this.nodeOut)}else this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut);return t},popFront:function(){var t=this.nodes.shift();return t&&(t.disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodes[0]||this.nodeOut)),t}},gswaComposition.prototype={bpm:function(t){if(!arguments.length)return this._bpm;if(t=Math.max(1,t),t!==this._bpm){var i=this._bpm/60,n=i/(t/60),e=this.currentTime();this.samples.forEach(function(t){t.when*=n}),this.isLooping&&this.loop(this.loopWhen*n,this.loopDuration*n),this._bpm=t,this._updateDuration(),this.currentTime(e*n)}return this},add:function(t){return t.forEach?t.forEach(this._add):this._add(t),this},remove:function(t){return t.forEach?t.forEach(this._remove):this._remove(t),this},getSampleAt:function(t){return this.samples.findIndex(function(i){return i.when+i.duration>t})},update:function(t,i){return"rm"!==i&&this.samples.sort(function(t,i){return t.when<i.when?-1:t.when>i.when?1:0}),this._updateDuration(),this.oldDuration!==this.duration&&this._updateEndTimeout(),this.isPlaying&&(t.stop(),"rm"!==i&&(this.isLooping?this._loopUpdate(t):this._sampleStart(t,0,this.currentTime(),1/0))),this},currentTime:function(t){function i(t){return!n.isLooping||t<n.loopEnd?t:n.loopWhen+(t-n.loopWhen)%n.loopDuration}var n=this;return arguments.length?(this.isPlaying&&this._stop(),this._currentTime=i(Math.max(0,Math.min(t,this.duration))),this.isPlaying&&this._play(),this):this.isPlaying?i(this._currentTime+this.wCtx.ctx.currentTime-this._startedTime):this._currentTime},play:function(){return this.isPlaying||(this.isPlaying=!0,this.isPaused=!1,this._play()),this},stop:function(){return(this.isPlaying||this.isPaused)&&(this._stop(),this.onended()),this},pause:function(){return this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this._currentTime+=this.wCtx.ctx.currentTime-this._startedTime,this._startedTime=0,this._stop(),this.fnOnpaused()),this},onended:function(t){return"function"==typeof t?this.fnOnended=t:(this.isPlaying=this.isPaused=!1,this._startedTime=this._currentTime=0,this.fnOnended()),this},_add:function(t){this.samples.indexOf(t)<0&&(this.samples.push(t),t.composition=this,this.update(t,"ad"))},_remove:function(t){var i=this.samples.indexOf(t);i>-1&&(t.composition=null,this.samples.splice(i,1),this.update(t,"rm"))},_stop:function(){clearTimeout(this._endTimeout),clearTimeout(this._loopTimeout),this.samples.forEach(function(t){t.stop()})},_play:function(){this._startedTime=this.wCtx.ctx.currentTime,this.isLooping?this._loopPlay():this.samples.forEach(function(t){this._sampleStart(t,0,this.currentTime(),1/0)},this),this._updateEndTimeout()},_updateDuration:function(){var t=this.samples[this.samples.length-1];this.duration=t?t.when+t.duration:0},_updateEndTimeout:function(){if(clearTimeout(this._endTimeout),this.isPlaying&&!this.isLooping){var t=this.duration-this.currentTime();this.oldDuration=this.duration,t<=0?this.onended():this._endTimeout=setTimeout(this.onended,1e3*t)}},_sampleStart:function(t,i,n,e){var s=t.when,o=t.offset,h=t.duration,r=s-n;r>-h&&s<e&&(s+h>e&&(h-=s+h-e),r<0&&(o-=r,h+=r,r=0),t.start(r+i,o,h))}},Object.assign(gswaComposition.prototype,{loop:function(t,i){return this.isLooping=t!==!1,this.isLooping?(this.loopWhen=t,this.loopDuration=i,this.loopEnd=t+i):clearTimeout(this._loopTimeout),this.isPlaying&&this.currentTime(this.currentTime()),this},_loopPlay:function(){clearTimeout(this._loopTimeout),this.samples.some(function(t){return!(t.when<this.loopEnd)||void this._sampleStart(t,0,this.currentTime(),this.loopEnd)},this),this.currentTime()>=this.loopWhen?this._loopStart():this._loopTimeout=setTimeout(this._loopStart.bind(this),1e3*(this.loopWhen-this.currentTime()))},_loopStart:function(){this._loopN=Math.ceil(2/this.loopDuration),this._loopNbStarted=1,this._loopTimeout=setInterval(this._loopTimer.bind(this),1e3),this._loopTimer()},_loopRemain:function(){return this._loopNbStarted-(this.wCtx.ctx.currentTime-this._startedTime+this._currentTime-this.loopWhen)/this.loopDuration},_loopTimer:function(){if(this._loopRemain()<this._loopN){var t,i,n=0,e=this.getSampleAt(this.loopWhen);if(e>-1)for(;n++<this._loopN;){for(i=e;(t=this.samples[i])&&t.when<this.loopEnd;++i)this._sampleStart(t,this._loopRemain()*this.loopDuration,this.loopWhen,this.loopEnd);++this._loopNbStarted}}},_loopUpdate:function(t){if(this._sampleStart(t,0,this.currentTime(),this.loopEnd),t.when+t.duration>this.loopWhen&&t.when<this.loopEnd)for(var i=1;i<this._loopRemain();++i)this._sampleStart(t,i*this.loopDuration-(this.currentTime()-this.loopWhen),this.loopWhen,this.loopEnd)}}),gswaComposition.prototype.render=function(){var t,i,n,e,s=this,o=this.duration;if(o)return this.stop(),this.isLooping&&(n=this.loopWhen,e=this.loopDuration),t=this.wCtx.ctx,i=this.wCtx.ctx=new OfflineAudioContext(2,44100*o,44100),this.samples.forEach(function(t){t.stop(),t.connect(i.destination)}),this.currentTime(0),e&&this.loop(!1),this.play(),i.startRendering().then(function(i){var o=new DataView(gswaEncodeWAV(i)),h=new Blob([o],{type:"audio/wav"});return s.wCtx.ctx=t,s.samples.forEach(function(i){i.stop(),i.connect(t.destination)}),e&&s.loop(n,e),h}).catch(function(t){console.error("gs-webaudio-library: composition.render() just failed: "+t)})};