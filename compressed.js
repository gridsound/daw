"use strict";function walContext(){this.ctx=new window.AudioContext,this.destination=this.ctx.destination,this.filters=this.createFilters(),this.buffers=[],this.compositions=[],this.nbPlaying=0,this.filters.connect(this.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}function extractData(e){function t(e){var i=new Promise(function(i){e.isFile?e.file(function(e){e.type&&"text/plain"!==e.type?a.push(e):n||(n=e,gs.reset()),i()}):e.isDirectory&&(s=e.createReader(),s.readEntries(function(e){var s=[];$.each(e,function(){s.push(t(this))}),Promise.all(s).then(function(){i()})}))});return i}var i,s,n,a=[],o=[];$.each(e,function(){(i=this.webkitGetAsEntry())&&o.push(t(i))}),Promise.all(o).then(function(){gs.load(n).then(function(){loadFile(a)})})}function loadFile(e){e.forEach(function(e){gs.files.some(function(t){var i=t.file?t.file.size:t.size;return t.fullname===e.name&&i===e.size?(t.file||t.joinFile(e),!0):void 0})||gs.fileCreate(e)})}window.AudioContext=window.AudioContext||window.webkitAudioContext,walContext.prototype={gain:function(e){return arguments.length?(this.filter.gain(e),this):this.filter.gain()},createBuffer:function(e){var t=this;return new Promise(function(i,s){new walContext.Buffer(t,e,i,s)}).then(function(e){return t.buffers.push(e),e})},createFilters:function(){return new walContext.Filters(this)},createComposition:function(){var e=new walContext.Composition(this);return this.compositions.push(e),e}},function(){function e(e){var t,i=null,s=0;e.wSamples.forEach(function(e){t=e.getEndTime(),t>s&&(s=t,i=e)}),e.lastSample=i,e.duration=i?i.getEndTime():0}function t(t){clearTimeout(t.playTimeoutId),e(t);var i=t.duration&&t.duration-t.currentTime();0>=i?t.onended():t.playTimeoutId=setTimeout(t.onended.bind(t),1e3*i)}function i(e,t){var i=e.when-t;e.start(i,i>0?e.offset:e.offset-i,i>0?e.duration:e.duration+i)}function s(e,s,n,a){var o=e.currentTime();s.getEndTime()>o&&"rm"!==n&&(s.load(),i(s,o)),e.lastSample===a&&"mv"!==n||t(e)}function n(e){clearTimeout(e.playTimeoutId),e.wSamples.forEach(function(e){e.stop()})}function a(e){var t=e.currentTime();e.wSamples.forEach(function(e){e.getEndTime()>t&&e.load()})}function o(e){var s=e.currentTime();e.wSamples.forEach(function(e){e.getEndTime()>s&&i(e,s)}),t(e)}walContext.Composition=function(e){this.wCtx=e,this.wSamples=[],this.lastSample=null,this.isPlaying=this.isPaused=!1,this.duration=this.startedTime=this._currentTime=0,this.fnOnended=this.fnOnpaused=function(){}},walContext.Composition.prototype={addSamples:function(e){var t=this;return e.forEach(function(e){t.wSamples.indexOf(e)<0&&(t.wSamples.push(e),e.composition=this,t.update(e))}),this},removeSamples:function(e){var t,i=this;return e.forEach(function(e){t=i.wSamples.indexOf(e),t>-1&&(i.wSamples.splice(t,1),e.composition=null,i.update(e,"rm"))}),this},update:function(t,i){var n,a=this,o=this.lastSample;return e(this),this.isPlaying&&(t.started?(n=t.fnOnended,t.onended(function(){s(a,t,i,o),n(),t.onended(n)}),t.stop()):s(this,t,i,o)),this},currentTime:function(e){return arguments.length?(this.isPlaying&&n(this),this._currentTime=Math.max(0,Math.min(e,this.duration)),this.isPlaying&&(this.startedTime=this.wCtx.ctx.currentTime,a(this),o(this)),this):this._currentTime+(this.isPlaying&&wa.wctx.ctx.currentTime-this.startedTime)},play:function(){return this.isPlaying||(this.isPlaying=!0,this.isPaused=!1,this.startedTime=wa.wctx.ctx.currentTime,a(this),o(this)),this},stop:function(){return(this.isPlaying||this.isPaused)&&(n(this),this.onended()),this},pause:function(){this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this._currentTime+=wa.wctx.ctx.currentTime-this.startedTime,this.startedTime=0,n(this),this.fnOnpaused())},onended:function(e){return"function"==typeof e?this.fnOnended=e:(this.isPlaying=this.isPaused=!1,this.startedTime=this._currentTime=0,this.fnOnended()),this}}}(),function(){walContext.Buffer=function(e,t,i,s){function n(e){a.wCtx.ctx.decodeAudioData(e,function(e){a.buffer=e,a.isReady=!0,i(a)},s)}var a=this,o=new FileReader;this.wCtx=e,this.isReady=!1,t.name?(o.addEventListener("loadend",function(){n(o.result)}),o.readAsArrayBuffer(t)):n(t)},walContext.Buffer.prototype={createSample:function(){var e=new walContext.Sample(this.wCtx,this);return e},getPeaks:function(e,t,i,s){i=i||0,s=s||this.buffer.duration;for(var n,a,o,u=0,r=new Array(t),l=this.buffer.getChannelData(e),c=(s-i)*this.buffer.sampleRate,d=i*this.buffer.sampleRate,m=c/t,f=m/10;t>u;++u){for(n=d+u*m,a=n+m,o=0;a>n;n+=f)o=Math.max(o,Math.abs(l[~~n]));r[u]=o}return r}}}(),function(){function e(e,t,i){e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3]}function t(t,i,s,n){var a,o,u,r=i.data,l=0,c=i.width,d=i.height,m=d/2,f=t.getPeaks(0,c),h=t.buffer.numberOfChannels>1?t.getPeaks(1,c):f;if(n){for(;l<r.length;l+=4)e(r,l,s);s=[0,0,0,0]}for(l=0;c>l;++l){for(o=~~(m*(1-f[l])),u=~~(m*(1+h[l])),a=o;u>=a;++a)e(r,4*(a*c+l),s);e(r,4*(m*c+l),s)}return i}walContext.Buffer.prototype.drawWaveform=function(e,i){return t(this,e,i)},walContext.Buffer.prototype.drawInvertedWaveform=function(e,i){return t(this,e,i,!0)}}(),walContext.Filters=function(e){this.wCtx=e,this.nodes=[],this.nodeIn=e.ctx.createGain(),this.nodeOut=e.ctx.createGain(),this.nodeIn.connect(this.nodeOut),this.connect(e)},walContext.Filters.prototype={connect:function(e){e=e.nodeIn||e,e instanceof AudioNode&&(this.connectedTo=e,this.nodeOut.connect(e))},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},empty:function(){this.nodes.length&&(this.nodes[this.nodes.length-1].disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[])},gain:function(e){return arguments.length?void(this.nodeOut.gain.value=e):this.nodeOut.gain.value},pushBack:function(e){if(this.nodes.length){var t=this.nodes[this.nodes.length-1];t.disconnect(),t.connect(e)}else this.nodeIn.disconnect(),this.nodeIn.connect(e);e.connect(this.nodeOut),this.nodes.push(e)},pushFront:function(e){this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(e),e.connect(this.nodes[0]),this.nodes.unshift(e)):this.pushBack(e)},popBack:function(){var e=this.nodes.pop();if(e)if(e.disconnect(),this.nodes.length){var t=this.nodes[this.nodes.length-1];t.disconnect(),t.connect(this.nodeOut)}else this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut);return e},popFront:function(){var e=this.nodes.shift();return e&&(e.disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodes[0]||this.nodeOut)),e}},walContext.Sample=function(e,t,i){this.wCtx=e,this.wBuffer=t,this.connectedTo=i?i.nodeIn:e.nodeIn,this.when=this.offset=0,this.duration=this.bufferDuration=t.buffer.duration,this.fnOnended=function(){},this.loaded=this.started=this.playing=!1},walContext.Sample.prototype={connect:function(e){return e=e.nodeIn||e,e instanceof AudioNode&&(this.connectedTo=e,this.source&&this.source.connect(e)),this},disconnect:function(){return this.source&&(this.source.disconnect(),this.connectedTo=null),this},load:function(){return this.loaded||(this.loaded=!0,this.source=this.wCtx.ctx.createBufferSource(),this.source.buffer=this.wBuffer.buffer,this.source.onended=this.onended.bind(this),this.connectedTo&&this.source.connect(this.connectedTo)),this},start:function(e,t,i){function s(){++n.wCtx.nbPlaying,n.playing=!0}if(this.loaded)if(this.started)console.warn("WebAudio Library: can not start a sample twice.");else{var n=this;this.started=!0,e=void 0!==e?e:this.when,this.source.start(this.wCtx.ctx.currentTime+e,void 0!==t?t:this.offset,void 0!==i?i:this.duration),e?this.playTimeoutId=setTimeout(s,1e3*e):s()}else console.warn("WebAudio Library: can not start an unloaded sample.");return this},stop:function(){return this.started&&(this.source.onended=null,this.source.stop(0),this.onended()),this},getEndTime:function(){return this.when+this.duration},onended:function(e){return"function"==typeof e?this.fnOnended=e:this.loaded&&(this.playing&&(this.playing=!1,--this.wCtx.nbPlaying),this.started&&(this.started=!1,clearTimeout(this.playTimeoutId)),this.loaded=!1,this.source=null,this.fnOnended()),this}},function(){function e(t){for(var i,s=t.firstChild;null!==s;)e(i=s),s=s.nextSibling,1!==i.nodeType&&/^\s*$/.test(i.textContent)&&t.removeChild(i)}var t=$("#app"),i=Handlebars.templates;for(var s in i)"_app"!==s&&Handlebars.registerPartial(s,i[s]);t.append(Handlebars.templates._app({})),e(document.body),window.ui={jqWindow:$(window),jqBody:$("body"),jqApp:t,jqAbout:$("#about"),jqVisual:$("#visual"),jqVisualCanvas:$("#visual canvas"),jqClockMin:$("#visual .clock .min"),jqClockSec:$("#visual .clock .sec"),jqClockMs:$("#visual .clock .ms"),jqMenu:$("#menu"),jqPlay:$("#menu .btn.play"),jqStop:$("#menu .btn.stop"),jqBpmA:$("#menu .bpm .a-bpm"),jqBpmInt:$("#menu .bpm .int"),jqBpmDec:$("#menu .bpm .dec"),jqBpmList:$("#menu .bpm-list"),jqBtnTools:$("#menu .tools [data-tool]"),jqBtnMagnet:$("#menu .tools .magnet"),jqBtnSave:$("#menu .tools .save"),jqBtnAbout:$("#menu .about"),jqFiles:$("#files"),jqFilelist:$("#files .filelist"),jqInputFile:$("#files .filelist input[type='file']"),jqGrid:$("#grid"),jqGridEm:$("#grid .emWrapper"),jqGridHeader:$("#grid .header"),jqTimeline:$("#grid .timeline"),jqTimeArrow:$("#grid .timeArrow"),jqTimeCursor:$("#grid .timeCursor"),jqTrackList:$("#grid .trackList"),jqGridCols:$("#grid .cols"),jqGridColB:$("#grid .colB"),jqTrackNames:$("#grid .trackNames"),jqTrackLines:$("#grid .trackLines"),jqTrackLinesBg:$("#grid .trackLinesBg"),jqTrackNamesExtend:$("#grid .trackNames .extend"),tool:{},tracks:[],nbTracksOn:0},ui.gridEm=parseFloat(ui.jqGrid.css("fontSize")),ui.gridColsY=ui.jqGridCols.offset().top,ui.jqVisualCanvas[0].height=ui.jqVisualCanvas.height()}(),function(){function e(){var a=i;wa.wctx.nbPlaying&&(a=wa.analyserArray,wa.analyser.getByteTimeDomainData(a)),wa.oscilloscope(s,n,a),t=requestAnimationFrame(e)}var t,i=[],s=ui.jqVisualCanvas[0],n=s.getContext("2d");ui.analyserEnabled=!1,ui.analyserToggle=function(i){"boolean"!=typeof i&&(i=!ui.analyserEnabled),ui.analyserEnabled=i,i?t=requestAnimationFrame(e):(n.clearRect(0,0,s.width,s.height),cancelAnimationFrame(t))}}(),ui.BPMem=1,ui.bpm=function(e){var t=~~e,i=Math.min(Math.round(100*(e-t)),99);ui.BPMem=e/60,ui.jqBpmInt.text(100>t?"0"+t:t),ui.jqBpmDec.text(10>i?"0"+i:i)},function(){function e(e){e>0&&ui.jqTimeCursor.add(ui.jqTimeArrow).css("left",e*ui.BPMem+"em"),ui.jqTimeCursor[0].classList.toggle("visible",e>0),ui.jqTimeArrow[0].classList.toggle("visible",e>0)}function t(e){ui._clockTime=e,ui.jqClockMin.text(~~(e/60));var t=~~(e%60);ui.jqClockSec.text(10>t?"0"+t:t),e=Math.round(1e3*(e-~~e)),10>e?e="00"+e:100>e&&(e="0"+e),ui.jqClockMs.text(e)}ui.currentTime=function(i){t(i),e(i)}}(),function(){function e(e,t){return Math.abs(e-t)<1e-4}function t(e){var t=e%i;return e-=t,t>s&&(e+=i),e}var i=.25,s=i/2;ui.xemFloor=function(s){var n=t(s);return s>n||e(n,s)?n:n-i},ui.xemCeil=function(s){var n=t(s);return n>s||e(n,s)?n:n+i},ui.getGridXem=function(e){var i=(e-ui.filesWidth-ui.trackNamesWidth-ui.trackLinesLeft)/ui.gridEm;return ui.isMagnetized?t(i):i}}(),ui.getTrackFromPageY=function(e){return ui.tracks[Math.floor((e-ui.gridColsY+ui.gridScrollTop)/ui.gridEm)]},ui.CSS_fileToLoad=function(e){e.jqToLoad.addClass("fa-download"),e.jqFile.addClass("to-load")},ui.CSS_fileWithoutData=function(e){e.jqToLoad.addClass("fa-question")},ui.CSS_fileLoading=function(e){e.jqToLoad.removeClass("fa-download").addClass("fa-refresh fa-spin")},ui.CSS_fileReady=function(e){e.jqToLoad.remove(),e.jqFile.removeClass("to-load")},ui.CSS_fileError=function(e){e.jqToLoad.removeClass("fa-refresh fa-spin").addClass("fa-times")},ui.newTrack=function(){ui.tracks.push(new ui.Track(this))},function(){function e(){ui.currentTime(wa.composition.currentTime()),t=requestAnimationFrame(e)}var t;ui.play=function(){ui.jqPlay[0].classList.remove("fa-play"),ui.jqPlay[0].classList.add("fa-pause"),e()},ui.pause=function(){cancelAnimationFrame(t),ui.jqPlay[0].classList.remove("fa-pause"),ui.jqPlay[0].classList.add("fa-play")},ui.stop=function(){ui.pause(),ui.currentTime(0)}}(),ui.resize=function(){ui.screenWidth=ui.jqWindow.width(),ui.screenHeight=ui.jqWindow.height(),ui.gridColsWidth=ui.jqGridCols.width(),ui.gridColsHeight=ui.jqTrackList.height(),ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.updateTimeline(),ui.updateTrackLinesBg()},ui.CSS_sampleTrack=function(e){e.track.jqColLinesTrack.append(e.jqSample)},ui.CSS_sampleWhen=function(e){e.jqSample.css("left",e.wsample.when*ui.BPMem+"em")},ui.CSS_sampleSelect=function(e){e.jqSample.toggleClass("selected",e.selected)},ui.CSS_sampleDelete=function(e){e.jqSample.remove()},ui.CSS_sampleOffset=function(e){e.jqWaveform.css("marginLeft",-e.wsample.offset*ui.BPMem+"em")},ui.CSS_sampleDuration=function(e){e.jqSample.css("width",e.wsample.duration*ui.BPMem+"em"),e.jqWaveform.css("width",e.wsample.bufferDuration*ui.BPMem+"em")},ui.CSS_sampleWaveform=function(e){var t=e.canvas.width=~~(300*e.wsample.bufferDuration),i=e.canvas.height=50,s=e.canvasCtx.createImageData(t,i);e.wsample.wBuffer.drawWaveform(s,[221,221,255,255]),e.canvasCtx.putImageData(s,0,0)},ui.selectTool=function(){var e;return function(t){var i,s=ui.jqBtnTools.tool[t];s!==e&&(e&&(e.classList.remove("active"),(i=ui.tool[ui.currentTool].mouseup)&&i({})),e=s,ui.jqGrid[0].dataset.tool=ui.currentTool=t,s.classList.add("active"))}}(),ui.setFilesWidth=function(e){ui.jqFiles.css("width",e),ui.filesWidth=e=ui.jqFiles.outerWidth(),ui.gridColsWidth=ui.screenWidth-e,ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.jqGrid.css("left",e),ui.jqVisual.css("width",e+ui.trackNamesWidth),ui.jqMenu.css("left",e+ui.trackNamesWidth),ui.jqVisualCanvas[0].width=ui.jqVisualCanvas.width(),ui.updateTimeline(),ui.updateTrackLinesBg()},ui.gridScrollTop=0,ui.setGridScrollTop=function(e){ui.jqGridCols[0].scrollTop=ui.gridScrollTop=0>=e?0:Math.min(e,ui.tracks.length*ui.gridEm-ui.gridColsHeight),ui.updateGridTopShadow()},ui.gridZoom=1,ui.setGridZoom=function(e,t,i){e=Math.min(Math.max(1,e),8);var s=e/ui.gridZoom;ui.gridZoom=e,ui.gridEm*=s,ui.jqGridEm.css("fontSize",e+"em"),ui.jqGrid.attr("data-sample-size",ui.gridEm<40?"small":ui.gridEm<80?"medium":"big"),ui.setGridScrollTop(-(i-(ui.gridScrollTop+i)*s)),ui.setTrackLinesLeft(t-(-ui.trackLinesLeft+t)*s),ui.updateTimeline(),ui.updateTrackLinesBg()},ui.setTrackLinesLeft=function(e){ui.trackLinesLeft=e=Math.min(~~e,0),ui.jqTrackLines.css("marginLeft",e/ui.gridEm+"em"),ui.updateGridLeftShadow()},ui.trackNamesWidth=0,ui.setTrackNamesWidth=function(e){var t,i=ui.trackNamesWidth;ui.jqTrackNames.css("width",e),ui.trackNamesWidth=e=ui.jqTrackNames.outerWidth(),ui.trackLinesWidth=ui.gridColsWidth-e,t=ui.filesWidth+e,ui.jqGridColB.css("left",e),ui.jqTimeline.css("left",e),ui.jqVisual.css("width",t),ui.jqMenu.css("left",t),ui.jqVisualCanvas[0].width=t,ui.trackLinesLeft<0&&ui.setTrackLinesLeft(ui.trackLinesLeft-(e-i)),ui.updateTimeline(),ui.updateTrackLinesBg()},ui.toggleAbout=function(e){ui.jqAbout.toggleClass("show",e)},ui.isMagnetized=!1,ui.toggleMagnetism=function(e){"boolean"!=typeof e&&(e=!ui.isMagnetized),ui.isMagnetized=e,ui.jqBtnMagnet.toggleClass("active",e)},ui.toggleTracks=function(e){for(var t,i=0,s=e.isOn&&1===ui.nbTracksOn;t=ui.tracks[i++];)t.toggle(s);e.toggle(!0)},function(){var e=2,t="rgba(0,0,0,.3)",i="px "+e+"px "+t;ui.updateGridLeftShadow=function(){var e=-ui.trackLinesLeft;ui.jqTrackNames.css("boxShadow",e?Math.min(2+e/8,5)+"px 0"+i:"none")},ui.updateGridTopShadow=function(){var e=ui.gridScrollTop;ui.jqGridHeader.css("boxShadow",e?"0px "+Math.min(2+e/8,5)+i:"none")}}(),function(){function e(e){if(e>t){var s,n="",a=t;for(t=e;a++<e;)n+="<div><span></span></div>";s=$(n),ui.jqTimeline.append(s),i.length<2&&(i=i.add(s.eq(0)))}}var t=0,i=$(ui.jqTimeArrow);ui.updateTimeline=function(){var t=ui.trackLinesLeft/ui.gridEm,s=ui.trackLinesWidth/ui.gridEm;e(Math.ceil(-t+s)),i.css("marginLeft",t+"em")}}(),function(){function e(e){var s,n,a,o=e-i,u="";for(i=Math.max(e,i),s=0;o>s;++s){for(u+="<div>",n=0;4>n;++n){for(u+="<div>",a=0;4>a;++a)u+="<div></div>";u+="</div>"}u+="</div>"}ui.jqTrackLinesBg.append(u),t=t||ui.jqTrackLinesBg.children().eq(0)}var t,i=0;ui.updateTrackLinesBg=function(){e(Math.ceil(ui.trackLinesWidth/ui.gridEm/4)+2),t.css("marginLeft",ui.trackLinesLeft/ui.gridEm%8+"em")}}(),ui.Track=function(e,t){t=t||{},this.grid=e,this.id=ui.tracks.length,this.jqColNamesTrack=$("<div class='track'>").appendTo(ui.jqTrackNames),this.jqColLinesTrack=$("<div class='track'>").appendTo(ui.jqTrackLines),this.jqColNamesTrack[0].uitrack,this.jqColLinesTrack[0].uitrack=this,this.wfilters=wa.wctx.createFilters(),this.samples=[],this.initToggle().initEditName().toggle(t.toggle!==!1).editName(t.name||"")},ui.Track.prototype={removeSample:function(e){var t=this.samples.indexOf(e);t>=0&&this.samples.splice(t,1)}},ui.Track.prototype.initEditName=function(){var e=this;return this.jqName=$("<span class='name text-overflow'>").appendTo(this.jqColNamesTrack).dblclick(this.editName.bind(this,!0)),this.jqNameInput=$("<input type='text'/>").appendTo(this.jqColNamesTrack).blur(function(){e.editName(this.value).editName(!1)}).keydown(function(t){13!==t.keyCode&&27!==t.keyCode||e.editName(13===t.keyCode?this.value:e.name).editName(!1),t.stopPropagation()}),this},ui.Track.prototype.editName=function(e){var t=this.jqNameInput[0],i="Track "+(this.id+1);return"string"==typeof e?(e=e.replace(/^\s+|\s+$/,"").replace(/\s+/g," "),e=e===i?"":e,this.jqName.toggleClass("empty",""===e).text(e||i),this.name=e):e?(this.jqColNamesTrack.addClass("editing"),t.value=this.name||i,t.focus(),t.select()):(t.blur(),this.jqColNamesTrack.removeClass("editing")),this},ui.Track.prototype.initToggle=function(){var e=this;return this.jqToggle=$("<a class='toggle'>").appendTo(this.jqColNamesTrack).on("contextmenu",!1).mousedown(function(t){0===t.button?e.toggle():2===t.button&&ui.toggleTracks(e)}),this},ui.Track.prototype.toggle=function(e){return"boolean"!=typeof e&&(e=!this.isOn),this.isOn!==e&&(this.wfilters.gain(+e),this.isOn=e,this.grid.nbTracksOn+=e?1:-1,this.jqToggle.toggleClass("on",e),this.jqColNamesTrack.add(this.jqColLinesTrack).toggleClass("off",!e)),this},function(){var e=new walContext,t=e.ctx.createAnalyser();t.fftSize=1024,e.filters.pushBack(t),window.wa={wctx:e,ctx:e.ctx,analyser:t,analyserArray:new Uint8Array(t.frequencyBinCount),composition:e.createComposition()}}(),wa.oscilloscope=function(){var e=0,t=Math.PI/2;return function(i,s,n){var a,o=0,u=i.width,r=i.height,l=n.length,c=l/2,d=u/l;for(s.globalCompositeOperation="source-in",s.fillStyle="rgba("+Math.round(255-255*e)+","+Math.round(64*e)+","+Math.round(255*e)+","+(.95-.25*(1-Math.cos(e*t)))+")",s.fillRect(0,0,u,r),e=0,s.globalCompositeOperation="source-over",s.save(),s.translate(0,r/2),s.beginPath(),s.moveTo(0,0);l>o;++o)a=(n[o]-128)/128,e=Math.max(Math.abs(a),e),a*=.5-Math.cos((c>o?o:l-o)/c*Math.PI)/2,s.lineTo(o*d,a*r);s.lineJoin="round",s.lineWidth=1+Math.round(2*e),s.strokeStyle="rgba(255,255,255,"+Math.min(.3+4*e,1)+")",s.stroke(),s.restore()}}(),window.gs={files:[],samples:[],selectedSamples:[]},gs.bpm=function(e){if(!arguments.length)return gs._bpm;var t=gs.currentTime()*ui.BPMem;gs._bpm=Math.max(20,Math.min(e,999)),ui.bpm(gs._bpm),gs.samples.forEach(function(e){e.wsample?(e.wsample.when=e.xem/ui.BPMem,ui.CSS_sampleDuration(e),ui.CSS_sampleOffset(e)):(e.savedWhen=e.xem/ui.BPMem,e.jqSample.css("width",e.savedDuration*ui.BPMem+"em"))}),gs.currentTime(t/ui.BPMem)},gs.currentTime=function(e){return arguments.length?(wa.composition.currentTime(e),void ui.currentTime(wa.composition.currentTime())):wa.composition.currentTime()},gs.playToggle=function(e){"boolean"!=typeof e&&(e=!wa.composition.isPlaying),e?gs.play():gs.pause()},gs.play=function(){!wa.composition.isPlaying&&wa.composition.wSamples.length&&gs.samples.length&&(wa.composition.play(),wa.composition.isPlaying&&ui.play())},gs.pause=function(){wa.composition.isPlaying&&(wa.composition.pause(),ui.pause())},gs.stop=function(){wa.composition.stop(),gs.currentTime(0),ui.stop()},gs.load=function(e){var t,i,s,n=this,a=new FileReader;return s=new Promise(function(s,o){a.onload=function(e){n._save=JSON.parse(e.target.result),n.bpm(n._save.bpm),n._save.files.forEach(function(e){i=gs.fileCreate(e),i.samplesToSet=[]}),n._save.tracks.forEach(function(e){for(var t=e[0],i=e[1],s=e[2];t>=ui.tracks.length;)ui.newTrack();ui.tracks[t].isOn=i,ui.tracks[t].name=s}),n._save.samples.forEach(function(e){var i=e[0],s=e[1],n=e[2],a=e[3],o=e[4],u=e[5];t=gs.sampleCreate(gs.files[n]),t.gsfile.samplesToSet.push(t),t.track=ui.tracks[s],t.track.samples.push(t),ui.CSS_sampleTrack(t),t.xem=i,t.savedWhen=a,t.jqSample.css("left",a*ui.BPMem+"em"),t.savedOffset=o,t.savedDuration=u,t.jqSample.css("width",u*ui.BPMem+"em")}),s(n)},e?a.readAsText(e):s(n)})},gs.save=function(){var e={bpm:this._bpm,files:[],samples:[],tracks:[]};return gs.files.forEach(function(t){e.files.push([t.id,t.fullname,t.file?t.file.size:t.size])}),gs.samples.forEach(function(t){e.samples.push([t.xem,t.track.id,t.gsfile.id,t.wsample?t.wsample.when:t.savedWhen,t.wsample?t.wsample.offset:t.savedOffset,t.wsample?t.wsample.duration:t.savedDuration])}),ui.tracks.forEach(function(t){(t.isOn||t.samples.length||t.name||t.wfilters&&t.wfilters.length)&&e.tracks.push([t.id,t.isOn,t.name])}),{href:"data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),download:"s.txt"}},gs.reset=function(){return ui.tracks.forEach(function(e){e.editName(""),e.toggle(!0)}),gs.samples.forEach(function(e){gs.sampleSelect(e,!0)}),gs.samplesDelete(),gs.files.forEach(function(e){e.jqFile.remove()}),gs.files=[],this},window.onhashchange=function(){ui.toggleAbout("#about"===location.hash)},function(){function e(e,t){t=t.originalEvent.deltaY,gs.bpm(gs._bpm+(t>0?-e:t?e:0))}ui.jqBpmA.mousedown(function(){return ui.jqBpmA.toggleClass("clicked"),!1}),ui.jqBpmList.children().mousedown(function(){gs.bpm(+this.textContent)}),ui.jqBody.mousedown(function(){ui.jqBpmA.removeClass("clicked")}),ui.jqBpmInt.on("wheel",e.bind(null,1)),ui.jqBpmDec.on("wheel",e.bind(null,.01))}(),ui.jqTimeline.mouseup(function(e){gs.currentTime(ui.getGridXem(e.pageX)/ui.BPMem)}),function(){var e,t=!1,i={files:function(e){var t=e.pageX;ui.setFilesWidth(35>t?0:t)},trackNames:function(e){var t=e.pageX-ui.jqGrid.offset().left;ui.setTrackNamesWidth(35>t?0:t)}};$(".extend").mousedown(function(s){0===s.button&&(t=!0,ui.jqBody.addClass("cursor-ewResize"),e=i[this.dataset.mousemoveFn])}),ui.jqBody.mouseup(function(e){0===e.button&&t&&(t=!1,ui.jqBody.removeClass("cursor-ewResize"))}).mousemove(function(i){t&&e(i)})}(),ui.jqBody.on({dragover:!1,drop:function(e){e=e.originalEvent;var t=e&&e.dataTransfer,i=!1,s=[];return t.items?extractData(t.items):t.files.length?($.each(t&&t.files,function(){this.type&&"text/plain"!==this.type?s.push(this):i||(i=this,gs.reset())}),gs.load(i).then(function(){loadFile(s)})):alerte("Your browser doesn't support folders."),!1}}),function(){function e(){i&&(ui.selectTool(i),i=null),t=!1}var t,i,s,n=0,a=0;ui.jqWindow.blur(e),ui.jqGridCols.on({wheel:function(e){return"zoom"===ui.currentTool?(ui.tool.zoom.wheel(e.originalEvent),!1):void 0},scroll:function(){ui.gridScrollTop=ui.jqGridCols[0].scrollTop,ui.updateGridTopShadow()}}),ui.jqTrackLines.on({contextmenu:!1,mousedown:function(e){if(!t){t=!0,s=ui.getGridXem(e.pageX),n=e.pageX,a=e.pageY,2===e.button&&(i=ui.currentTool,ui.selectTool("delete"));var o=ui.tool[ui.currentTool].mousedown;o&&o(e,e.target.gsSample)}}}),ui.jqBody.on({wheel:function(e){return e.ctrlKey?!1:void 0},mousemove:function(e){if(t){var i=ui.tool[ui.currentTool].mousemove,o=ui.getGridXem(e.pageX);i&&i(e,e.target.gsSample,"hand"!==ui.currentTool?(o-s)*ui.gridEm:e.pageX-n,e.pageY-a),s=o,n=e.pageX,a=e.pageY}},mouseup:function(i){if(t){var s=ui.tool[ui.currentTool].mouseup;s&&s(i,i.target.gsSample),e()}}})}(),function(){function e(e){return e===o||e===u||e===r}function t(){s&&(ui.selectTool(s),s=null)}function i(e){switch(e.keyCode){case c:ui.jqAbout.hasClass("show")&&(ui.toggleAbout(!1),location.hash="");break;case a:gs.playToggle();break;case n:gs.fileStop(),gs.stop();break;case l:gs.samplesDelete();break;case h:ui.toggleMagnetism();break;case m:e.ctrlKey&&gs.samplesCopy();break;case v:e.ctrlKey&&gs.samplesPaste();break;default:return!0}}var s,n=8,a=13,o=16,u=17,r=32,l=46,c=27,d=66,m=67,f=68,h=71,p=72,g=77,w=83,v=86,T=90,q=[],j={};j[d]="paint",j[f]="delete",j[g]="mute",j[w]="slip",j[m]="cut",j[r]=j[p]="hand",j[o]=j[v]="select",j[u]=j[T]="zoom",ui.jqWindow.blur(t),ui.jqBody.keydown(function(t){var a=t.keyCode;if(!q[a]&&(q[a]=!0,i(t))){var o=j[a];o&&o!==ui.currentTool&&(e(a)&&(s=ui.currentTool),ui.selectTool(o))}return a===r||a===n?!1:void 0}).keyup(function(i){q[i.keyCode]=!1,e(i.keyCode)&&t()})}(),ui.jqPlay.click(function(){gs.fileStop(),gs.playToggle()}),ui.jqStop.click(function(){gs.fileStop(),gs.stop()}),wa.composition.onended(ui.stop),ui.jqWindow.on("resize",ui.resize),ui.jqBtnSave.click(function(){ui.jqBtnSave.attr(gs.save())}),ui.jqBtnMagnet.click(ui.toggleMagnetism),ui.jqBtnTools.tool={},ui.jqBtnTools.each(function(){ui.jqBtnTools.tool[this.dataset.tool]=this}).click(function(){ui.selectTool(this.dataset.tool)}),ui.tool["delete"]={mousedown:function(e,t){gs.sampleDelete(t)},mousemove:function(e,t){gs.sampleDelete(t)}},ui.tool.hand={mousedown:function(){ui.jqBody.addClass("cursor-move")},mouseup:function(){ui.jqBody.removeClass("cursor-move")},mousemove:function(e,t,i,s){ui.setTrackLinesLeft(ui.trackLinesLeft+i),ui.setGridScrollTop(ui.gridScrollTop-s),ui.updateTimeline(),ui.updateTrackLinesBg()}},ui.tool.mute={mousedown:function(e,t){t&&t.mute()},mousemove:function(e,t){t&&t.mute()}},function(){var e,t,i,s;ui.tool.paint={mousedown:function(n,a){a?(i=n.target.classList.contains("start"),s=n.target.classList.contains("end"),t=i||s,t&&(ui.jqBody.addClass("cursor-ewResize"),a[i?"jqCropStart":"jqCropEnd"].addClass("hover")),e=a):gs.samplesUnselect()},mouseup:function(){e&&(gs.samplesForEach(e,function(e){wa.composition.update(e.wsample,"mv")}),t&&(e[i?"jqCropStart":"jqCropEnd"].removeClass("hover"),t=i=s=!1,ui.jqBody.removeClass("cursor-ewResize")),e=null)},mousemove:function(i,n,a,o){if(e)if(a/=ui.gridEm,t)s?gs.samplesDuration(e,a):(a=-gs.samplesDuration(e,-a))&&(gs.samplesMoveX(e,a),gs.samplesSlip(e,-a));else{gs.samplesMoveX(e,a),i=i.target;var u,r=1/0,l=i.uitrack||i.gsSample&&i.gsSample.track;l&&(e.selected?(u=l.id-e.track.id,0>u&&(gs.selectedSamples.forEach(function(e){r=Math.min(e.track.id,r)}),u=-Math.min(r,-u)),gs.selectedSamples.forEach(function(e){e.inTrack(e.track.id+u)})):e.inTrack(l.id))}}}}(),function(){var e,t,i,s,n,a,o=0,u={width:0,height:0},r=$("<div id='squareSelection'>");ui.tool.select={mousedown:function(i,s){n=!0,e=i.pageX,t=i.pageY,i.shiftKey||gs.samplesUnselect(),s&&gs.sampleSelect(s,!s.selected)},mouseup:function(){n=a=!1,r.css(u).detach()},mousemove:function(u){if(n){var l,c,d=u.pageX,m=u.pageY;if(!a&&Math.max(Math.abs(d-e),Math.abs(m-t))>5&&(++o,a=!0,i=ui.getTrackFromPageY(t).id,s=ui.getGridXem(e),r.appendTo(ui.jqTrackLines)),a){l=ui.getTrackFromPageY(m),l=l?l.id:0,c=Math.max(0,ui.getGridXem(d));var f=Math.min(i,l),h=Math.max(i,l),p=Math.min(s,c),g=Math.max(s,c);gs.samples.forEach(function(e){var t,i,s=e.track.id;if(e.wsample){if(s>=f&&h>=s&&(t=e.xem,i=t+e.wsample.duration*ui.BPMem,t>=p&&g>t||i>p&&g>=i||p>=t&&i>=g))return void(e.selected||(e.squareSelected=o,gs.sampleSelect(e,!0)));e.squareSelected===o&&gs.sampleSelect(e,!1)}}),r.css({top:f+"em",left:p+"em",width:g-p+"em",height:h-f+1+"em"})}}}}}(),function(){var e;ui.tool.slip={mousedown:function(t,i){e=i},mouseup:function(){e&&gs.samplesForEach(e,function(e){wa.composition.update(e.wsample,"mv")}),e=null},mousemove:function(t,i,s){e&&gs.samplesSlip(e,s/ui.gridEm)}}}(),function(){function e(e,t){ui.setGridZoom(ui.gridZoom*t,e.pageX-ui.filesWidth-ui.trackNamesWidth,e.pageY-ui.gridColsY)}ui.tool.zoom={wheel:function(t){e(t,t.deltaY<0?1.1:.9)},mousedown:function(t){0===t.button&&e(t,t.altKey?.7:1.3)}}}(),gs.fileCreate=function(e){var t=new gs.File(e);return t.id=gs.files.length,gs.files.push(t),ui.jqFilelist.append(t.jqFile),t},function(){var e,t=$("<div class='cursor'>");gs.filePlay=function(i){e&&e.stop(),i.isLoaded&&(i.jqCanvasWaveform.after(t.css("transitionDuration",0).css("left",0)),e=i.wbuff.createSample().onended(gs.fileStop).load().start(),setTimeout(function(){t.css("transitionDuration",i.wbuff.buffer.duration+"s").css("left","100%")},20))},gs.fileStop=function(){e&&(e.stop(),t.detach())}}(),function(){var e;ui.jqInputFile.change(function(){e&&(e.joinFile(this.files[0]),e=null)}),gs.File=function(t){var i=this;this.isLoaded=this.isLoading=!1,this.file=t.length?null:t,this.fullname=t.name||t[1],this.name=this.fullname.replace(/\.[^.]+$/,""),this.jqFile=$(Handlebars.templates.file(this)),this.jqToLoad=this.jqFile.find(".to-load"),this.jqName=this.jqFile.find(".name"),this.file?ui.CSS_fileToLoad(this):(this.size=t[2],ui.CSS_fileWithoutData(this)),this.jqFile.on({contextmenu:!1,dragstart:this.dragstart.bind(this),mousedown:function(e){0!==e.button&&gs.fileStop()},click:function(){i.isLoaded?gs.filePlay(i):i.file?i.isLoading||i.load(gs.filePlay):(alert("Choose the file to associate or drag and drop "+i.name),e=i,ui.jqInputFile.click())}})}}(),function(){var e,t;ui.jqBody.mousemove(function(i){e&&t.css({left:i.pageX,top:i.pageY})}).mouseup(function(i){if(e){var s=ui.getTrackFromPageY(i.pageY),n=ui.getGridXem(i.pageX);t.remove(),s&&n>=0&&gs.sampleCreate(e,s.id,n),e=null}}),gs.File.prototype.dragstart=function(i){if(this.isLoaded&&!e){e=this,t=this.jqCanvasWaveform.clone();var s=t[0];s.getContext("2d").drawImage(this.jqCanvasWaveform[0],0,0,s.width,s.height),t.addClass("dragging").css({left:i.pageX,top:i.pageY}).appendTo(ui.jqBody)}return!1}}(),gs.File.prototype.joinFile=function(e){var t=this;this.file=e,this.jqToLoad.removeClass("fa-question").addClass("fa-download"),this.fullname!==e.name&&(this.fullname=e.name,this.name=this.fullname.replace(/\.[^.]+$/,""),this.jqName.text(this.name)),this.samplesToSet.length&&this.load(function(){t.samplesToSet.forEach(function(e){e.wsample=t.wbuff.createSample(),wa.composition.addSamples([e.wsample]),e.canvas=e.jqWaveform[0],e.canvasCtx=e.canvas.getContext("2d"),e.jqName.text(t.name),e.wsample.duration=e.savedDuration,e.wsample.offset=e.savedOffset,e.wsample.when=e.savedWhen,ui.CSS_sampleDuration(e),ui.CSS_sampleWaveform(e),e.wsample.connect(e.track.wfilters)})})},gs.File.prototype.load=function(e){var t=this;this.isLoading=!0,ui.CSS_fileLoading(this),wa.wctx.createBuffer(this.file).then(function(i){var s,n,a;t.wbuff=i,t.isLoaded=!0,t.isLoading=!1,ui.CSS_fileReady(t),t.jqCanvasWaveform=$("<canvas class='waveform'>"),s=t.jqCanvasWaveform[0],n=s.getContext("2d"),s.width=400,s.height=50,a=n.createImageData(s.width,s.height),i.drawWaveform(a,[57,57,90,255]),n.putImageData(a,0,0),t.jqFile.prepend(s),e(t)},function(){t.isLoading=!1,ui.CSS_fileError(t),alert('At this day, the file: "'+t.fullname+'" can not be decoded by your browser.\n')})},gs.sampleCreate=function(e,t,i){var s=new gs.Sample(e,t,i);return gs.samples.push(s),s},gs.sampleSelect=function(e,t){e&&e.wsample&&e.selected!==t&&(e.select(t),t?gs.selectedSamples.push(e):gs.selectedSamples.splice(gs.selectedSamples.indexOf(e),1))},gs.sampleDelete=function(e){e&&e.wsample&&(gs.sampleSelect(e,!1),gs.samples.splice(gs.samples.indexOf(e),1),e["delete"]())},gs.samplesForEach=function(e,t){e&&e.wsample&&(e.selected?gs.selectedSamples.forEach(function(e){e.wsample&&t(e)}):t(e))},function(){var e,t=[];gs.samplesCopy=function(){var i=1/0,s=-(1/0);t=gs.selectedSamples.map(function(e){return i=Math.min(i,e.xem),s=Math.max(s,e.xem+e.wsample.duration*ui.BPMem),e}),ui.isMagnetized&&(i=ui.xemFloor(i),s=ui.xemCeil(s)),e=s-i},gs.samplesPaste=function(){gs.samplesUnselect(),t.forEach(function(t){var i=gs.sampleCreate(t.gsfile,t.track.id,t.xem+e);i.slip(t.wsample.offset),i.duration(t.wsample.duration),gs.sampleSelect(i,!0)}),gs.samplesCopy()}}(),gs.samplesDelete=function(){gs.selectedSamples.slice(0).forEach(gs.sampleDelete),
gs.selectedSamples=[]},gs.samplesDuration=function(e,t){function i(e){s=Math.min(s,e.wsample.duration),t=Math.min(t,e.wsample.bufferDuration-e.wsample.duration)}var s=1/0;return e.wsample&&(t/=ui.BPMem,e.selected?gs.selectedSamples.forEach(i):i(e),0>t&&(t=-Math.min(s,-t)),gs.samplesForEach(e,function(e){e.duration(e.wsample.duration+t)})),t*ui.BPMem},gs.samplesMoveX=function(e,t){if(e.selected&&e.wsample&&0>t){var i=1/0;gs.selectedSamples.forEach(function(e){i=Math.min(i,e.xem)}),t=-Math.min(i,-t)}gs.samplesForEach(e,function(e){e.moveX(Math.max(0,e.xem+t))})},gs.samplesSlip=function(e,t){t/=ui.BPMem,gs.samplesForEach(e,function(e){e.slip(e.wsample.offset-t)})},gs.samplesUnselect=function(){gs.selectedSamples.forEach(function(e){e.select(!1)}),gs.selectedSamples=[]},gs.Sample=function(e,t,i){this.gsfile=e,this.jqSample=$(Handlebars.templates.sample(e)),this.jqWaveformWrapper=this.jqSample.find(".waveformWrapper"),this.jqWaveform=this.jqSample.find(".waveform"),this.jqName=this.jqSample.find(".name"),this.jqCropStart=this.jqSample.find(".crop.start"),this.jqCropEnd=this.jqSample.find(".crop.end");var s=this;this.jqSample.find("*").each(function(){this.gsSample=s}),e.file&&(this.wsample=e.wbuff.createSample(),this.canvas=this.jqWaveform[0],this.canvasCtx=this.canvas.getContext("2d"),this.inTrack(t),this.moveX(i),ui.CSS_sampleDuration(this),ui.CSS_sampleWaveform(this),wa.composition.addSamples([this.wsample])),this.select(!1)},gs.Sample.prototype["delete"]=function(){this.wsample&&(this.wsample.stop(),this.track.removeSample(this),wa.composition.removeSamples([this.wsample],"rm"),ui.CSS_sampleDelete(this))},gs.Sample.prototype.duration=function(e){this.wsample&&(this.wsample.duration=Math.max(0,Math.min(e,this.wsample.bufferDuration)),ui.CSS_sampleDuration(this))},gs.Sample.prototype.inTrack=function(e){var t=ui.tracks[e];t!==this.track&&this.wsample&&(this.wsample.disconnect(),this.wsample.connect(t.wfilters),this.track&&this.track.removeSample(this),this.track=t,this.track.samples.push(this),ui.CSS_sampleTrack(this))},gs.Sample.prototype.moveX=function(e){this.wsample&&(this.xem=e,this.when(e/ui.BPMem))},gs.Sample.prototype.mute=function(){lg("sample muted (in development)")},gs.Sample.prototype.select=function(e){this.wsample&&(this.selected=e,ui.CSS_sampleSelect(this))},gs.Sample.prototype.slip=function(e){this.wsample&&(this.wsample.offset=Math.min(this.wsample.bufferDuration,Math.max(e,0)),ui.CSS_sampleOffset(this))},gs.Sample.prototype.when=function(e){this.wsample&&(this.wsample.when=e,ui.CSS_sampleWhen(this))},ui.resize(),ui.setFilesWidth(200),ui.setTrackLinesLeft(0),ui.setTrackNamesWidth(125),ui.setGridZoom(1.5,0,0),ui.analyserToggle(!0),ui.toggleMagnetism(!0),ui.updateTrackLinesBg(),gs.bpm(120),gs.currentTime(0),ui.jqBtnTools.filter("[data-tool='paint']").click();for(var i=0;42>i;++i)ui.newTrack();window.onhashchange();